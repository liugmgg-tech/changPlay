<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¿åŠ¨æŸ¥çœ‹</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { font-size: 24px; margin-bottom: 20px; color: #333; }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      background: white;
      border: none;
      font-size: 16px;
      color: #666;
      transition: all 0.3s;
    }
    .tab:hover { background: #f0f0f0; }
    .tab.active {
      background: #4CAF50;
      color: white;
    }
    
    .refresh-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .refresh-btn:hover { background: #1976D2; }
    
    .user-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .user-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #4CAF50;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      margin-right: 12px;
    }
    .user-name { font-size: 20px; font-weight: bold; }
    .status-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-dot.active { background: #4CAF50; animation: pulse 2s infinite; }
    .status-dot.idle { background: #9e9e9e; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .status-text { font-size: 16px; }
    .warning { color: #ff9800; font-size: 14px; margin-left: 8px; }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-top: 1px solid #eee;
    }
    .info-label { color: #666; }
    .info-value { font-weight: bold; }
    .points { color: #4CAF50; font-size: 24px; }
    .money { color: #ff9800; }
    .sync-time {
      font-size: 12px;
      color: #999;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sync-time-row {
      display: flex;
      justify-content: space-between;
    }
    .sync-time-label { min-width: 70px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .error { color: #f44336; padding: 20px; text-align: center; }
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 12px 0;
    }
    .stat-item {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    .stat-value.points { color: #4CAF50; }
    .persons-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .persons-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .person-tag {
      display: inline-block;
      background: #e3f2fd;
      color: #1976D2;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 13px;
      margin-right: 8px;
      margin-bottom: 4px;
    }
    .share-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .share-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .share-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .share-name {
      font-weight: 500;
      color: #333;
    }
    .share-detail {
      font-size: 13px;
      color: #4CAF50;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .month-nav-btn {
      background: #f0f0f0;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }
    .month-nav-btn:hover { background: #e0e0e0; }
    .month-title {
      font-size: 18px;
      font-weight: bold;
    }
    .month-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      padding: 12px;
      background: #e8f5e9;
      border-radius: 8px;
    }
    .month-summary-item {
      display: flex;
      flex-direction: column;
    }
    .month-summary-label {
      font-size: 12px;
      color: #666;
    }
    .month-summary-value {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
    }
    .month-summary-value.money { color: #ff9800; }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    .history-table th,
    .history-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    .history-table th {
      background: #f5f5f5;
      font-weight: 500;
      color: #666;
      font-size: 13px;
    }
    .history-table td {
      font-size: 14px;
    }
    .history-table .date-col {
      text-align: left;
      font-weight: 500;
    }
    .history-table .points-col { color: #4CAF50; }
    .history-table .money-col { color: #ff9800; }
    .history-table tr.today {
      background: #fff8e1;
    }
    
    .user-select {
      margin-bottom: 16px;
    }
    .user-select select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
      width: 100%;
      max-width: 200px;
    }
    
    .hidden { display: none; }
    
    .settings-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .settings-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #333;
    }
    .settings-warning {
      background: #fff3e0;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #e65100;
    }
    .clear-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    .clear-btn:hover { background: #d32f2f; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
    }
    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 16px;
    }
    .modal-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .modal-btn.cancel {
      background: #f5f5f5;
      color: #666;
    }
    .modal-btn.confirm {
      background: #f44336;
      color: white;
    }
    
    .admin-tab-btn {
      padding: 10px 20px;
      border: none;
      border-bottom: 3px solid transparent;
      background: transparent;
      cursor: pointer;
      font-size: 15px;
      color: #666;
      transition: all 0.2s;
    }
    .admin-tab-btn:hover {
      color: #333;
      background: #f5f5f5;
    }
    .admin-tab-btn.active {
      color: #4CAF50;
      border-bottom-color: #4CAF50;
      font-weight: 500;
    }
    
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .admin-table th,
    .admin-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .admin-table th {
      background: #f5f5f5;
      font-weight: 500;
      color: #666;
      font-size: 13px;
    }
    .admin-table tr:hover {
      background: #fafafa;
    }
    
    /* æŠ½å±‰/æŠ˜å é¢æ¿æ ·å¼ */
    .drawer {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f5f5f5;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    .drawer-header:hover {
      background: #eee;
    }
    .drawer-arrow {
      font-size: 12px;
      color: #666;
      transition: transform 0.2s;
    }
    .drawer.collapsed .drawer-arrow {
      transform: rotate(-90deg);
    }
    .drawer-content {
      padding: 16px;
      border-top: 1px solid #e0e0e0;
    }
    .drawer.collapsed .drawer-content {
      display: none;
    }
    
    /* æ¨¡æ€æ¡†å›ºå®šåº•éƒ¨æŒ‰é’®å¸ƒå±€ */
    .modal-body-scroll {
      max-height: calc(80vh - 70px);
      overflow-y: auto;
      padding-right: 4px;
    }
    .modal-footer-fixed {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 16px;
      border-top: 1px solid #eee;
      margin-top: 16px;
      background: white;
    }
    
    /* é«˜çº§å‚æ•°åŒºåŸŸ */
    .advanced-params {
      background: #fff8e1;
      border-radius: 8px;
      padding: 12px;
      margin-top: 8px;
    }
    .advanced-params-header {
      font-size: 13px;
      color: #e65100;
      margin-bottom: 8px;
    }
    
    /* æ‰‹æœºç«¯éšè— */
    @media (max-width: 600px) {
      .hide-mobile {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <h1 id="main-title" style="user-select: none;">è¿åŠ¨æŸ¥çœ‹ <span id="config-name" style="font-size: 14px; color: #999; margin-left: 8px;"></span></h1>
  
  <div class="tabs">
    <button class="tab active" onclick="switchTab('realtime')">å®æ—¶çŠ¶æ€</button>
    <button class="tab" onclick="switchTab('history')">å†å²è®°å½•</button>
    <button id="settings-tab" class="tab hidden" onclick="switchTab('settings')">è®¾ç½®</button>
  </div>
  
  <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
  
  <div id="realtime-content"></div>
  <div id="history-content" class="hidden"></div>
  <div id="settings-content" class="hidden"></div>
  
  <div id="clear-data-modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">æ¸…é™¤ç”¨æˆ·æ•°æ®</div>
      <p style="color: #666; margin-bottom: 12px;">æ­¤æ“ä½œå°†åˆ é™¤è¯¥ç”¨æˆ·çš„æ¯æ—¥è®°å½•å’Œæ´»åŠ¨æ˜ç»†ï¼Œä¸å¯æ¢å¤ï¼</p>
      <input type="password" id="clear-password-input" class="modal-input" placeholder="è¯·è¾“å…¥å¯†ç ">
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closePasswordModal()">å–æ¶ˆ</button>
        <button class="modal-btn confirm" onclick="confirmClearData()">ç¡®è®¤æ¸…é™¤</button>
      </div>
    </div>
  </div>
  
  <div id="unbind-modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">è§£é™¤è®¾å¤‡ç»‘å®š</div>
      <p style="color: #666; margin-bottom: 12px;">è§£é™¤åï¼Œæ–°è®¾å¤‡å¯ä»¥é‡æ–°ç»‘å®šæ­¤ID</p>
      <input type="password" id="unbind-password-input" class="modal-input" placeholder="è¯·è¾“å…¥å¯†ç ">
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeUnbindModal()">å–æ¶ˆ</button>
        <button class="modal-btn confirm" onclick="confirmUnbind()">ç¡®è®¤è§£ç»‘</button>
      </div>
    </div>
  </div>

  <script>
    const CLOUD_CONFIG_ID = 2;  // 1=å®, 2=é•¿
    
    const CLOUD_CONFIGS = {
      1: {
        name: 'å®',
        url: 'https://vilitaarloxpgjbqgjmz.supabase.co',
        key: 'sb_publishable_-dlcp8B_dKge-fjN1wd2yQ_KUkhGreZ'
      },
      2: {
        name: 'é•¿',
        url: 'https://dvcvjyqydxqapghesxaw.supabase.co',
        key: 'sb_publishable_JzvR-nqE9y4KSkSXnRMMlg_MZt7I0Yx'
      }
    };
    
    const CLOUD_CONFIG = CLOUD_CONFIGS[CLOUD_CONFIG_ID];
    const SUPABASE_URL = CLOUD_CONFIG.url;
    const SUPABASE_ANON_KEY = CLOUD_CONFIG.key;

    const activityNames = {
      'walk': 'æ•£æ­¥',
      'step': 'æ‘†æ‰‹è‡‚',
      'stand': 'ä¸¾æ‰‹æ”¾ä¸‹',
      'turn_head': 'è½¬å¤´',
      'raise_hand': 'ä¸¾æ‰‹',
      'clap': 'é¼“æŒ',
      'breath': 'æ·±å‘¼å¸',
      'say_good': 'è¯´å¥½'
    };

    let cachedData = null;
    let currentTab = 'realtime';
    let currentMonth = new Date().toISOString().substring(0, 7);
    let currentUserId = null;
    let settingsTab = 'users';

    async function fetchAPI(table) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function parseUTCDate(dateStr) {
      if (!dateStr) return null;
      try {
        const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
        if (!match) return new Date(dateStr);
        return new Date(Date.UTC(
          parseInt(match[1], 10),
          parseInt(match[2], 10) - 1,
          parseInt(match[3], 10),
          parseInt(match[4], 10),
          parseInt(match[5], 10),
          parseInt(match[6], 10)
        ));
      } catch (e) { return null; }
    }

    function checkFreshness(updatedAt) {
      if (!updatedAt) return { fresh: true, text: 'åˆšåˆš' };
      const diffMin = Math.floor((new Date() - parseUTCDate(updatedAt)) / 60000);
      if (diffMin < 0) return { fresh: true, text: 'åˆšåˆš' };
      
      const days = Math.floor(diffMin / 1440);
      const hours = Math.floor((diffMin % 1440) / 60);
      const mins = diffMin % 60;
      
      let timeText = '';
      if (days > 0) {
        timeText = `${days}å¤©${hours}å°æ—¶${mins}åˆ†é’Ÿå‰`;
      } else if (hours > 0) {
        timeText = `${hours}å°æ—¶${mins}åˆ†é’Ÿå‰`;
      } else {
        timeText = `${mins}åˆ†é’Ÿå‰`;
      }
      
      if (diffMin > 3) return { fresh: false, text: `âš ï¸ ${timeText}` };
      return { fresh: true, text: timeText };
    }

    function formatTime(isoString) {
      if (!isoString) return '--';
      const d = parseUTCDate(isoString);
      if (!d) return isoString;
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
    }

    function pointsToMoney(points, pointsToYuan = 100) {
      return (points / pointsToYuan).toFixed(2);
    }

    function addDays(dateStr, days) {
      const d = new Date(dateStr);
      d.setDate(d.getDate() + days);
      return d.toISOString().split('T')[0];
    }

    async function loadData() {
      const [users, liveStatus, dailyRecords, allActivities] = await Promise.all([
        fetchAPI('users?select=*'),
        fetchAPI('live_status?select=*'),
        fetchAPI('daily_records?select=*'),
        fetchAPI('activities?select=*&order=date.desc,time.desc')
      ]);
      
      console.log('dailyRecords:', dailyRecords);
      console.log('allActivities:', allActivities);
      
      let persons = [];
      try { persons = await fetchAPI('persons?select=*'); } catch (e) {}
      
      cachedData = { users, liveStatus, dailyRecords, allActivities, persons };
      if (!currentUserId && users.length > 0) {
        currentUserId = users[0].id;
      }
      return cachedData;
    }

    async function refreshData() {
      const btn = document.querySelector('.refresh-btn');
      btn.textContent = 'ğŸ”„ åŠ è½½ä¸­...';
      btn.disabled = true;
      
      try {
        await loadData();
        if (currentTab === 'realtime') {
          renderRealtime();
        } else {
          renderHistory();
        }
      } catch (e) {
        alert('åŠ è½½å¤±è´¥: ' + e.message);
      }
      
      btn.textContent = 'ğŸ”„ åˆ·æ–°';
      btn.disabled = false;
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('realtime-content').classList.add('hidden');
      document.getElementById('history-content').classList.add('hidden');
      document.getElementById('settings-content').classList.add('hidden');
      
      if (tab === 'realtime') {
        document.getElementById('realtime-content').classList.remove('hidden');
        renderRealtime();
      } else if (tab === 'history') {
        document.getElementById('history-content').classList.remove('hidden');
        renderHistory();
      } else if (tab === 'settings') {
        document.getElementById('settings-content').classList.remove('hidden');
        renderSettings();
      }
    }

    function renderRealtime() {
      const content = document.getElementById('realtime-content');
      if (!cachedData) {
        content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        return;
      }
      
      const { users, liveStatus, dailyRecords, allActivities, persons } = cachedData;
      const today = new Date().toISOString().split('T')[0];
      const yesterday = addDays(today, -1);
      const monthStart = today.substring(0, 7) + '-01';

      let html = '';

      for (const user of users) {
        const status = liveStatus.find(s => s.user_id === user.id) || {};
        const userActivities = allActivities.filter(a => a.user_id === user.id);
        const userPersons = persons.filter(p => p.user_id === user.id);
        const todayRecord = dailyRecords.find(r => r.user_id === user.id && r.date === today);
        const yesterdayRecord = dailyRecords.find(r => r.user_id === user.id && r.date === yesterday);
        const monthRecords = dailyRecords.filter(r => r.user_id === user.id && r.date >= monthStart && r.date <= today);

        const todayPoints = todayRecord?.total_points || 0;
        const todayMorning = todayRecord?.morning_points || 0;
        const todayAfternoon = todayRecord?.afternoon_points || 0;
        const yesterdayPoints = yesterdayRecord?.total_points || 0;
        const monthPoints = monthRecords.reduce((sum, r) => sum + (r.total_points || 0), 0);

        const morningStart = user.morning_start || '08:00';
        const morningEnd = user.morning_end || '11:30';
        const afternoonStart = user.afternoon_start || '14:00';
        const afternoonEnd = user.afternoon_end || '18:00';

        // è·å–ç”¨æˆ·é…ç½®
        const pointsToYuan = user.points_to_yuan || 100;
        const morningMax = user.morning_max_points || 1500;
        const afternoonMax = user.afternoon_max_points || 1500;
        const showMoney = user.show_money !== false;

        const freshness = checkFreshness(status.updated_at);
        const isActive = status.status === 'active';
        const activityName = activityNames[status.current_activity] || status.current_activity;
        const elapsedMin = Math.floor((status.elapsed_seconds || 0) / 60);
        const startedAt = isActive
          ? (status.activity_started_at ? formatTime(status.activity_started_at) : null)
          : (status.updated_at ? formatTime(status.updated_at) : null);

        const nowHour = new Date().getHours();
        const currentPeriod = nowHour < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ';

        // è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
        const morningPercent = Math.min(100, Math.round(todayMorning / morningMax * 100));
        const afternoonPercent = Math.min(100, Math.round(todayAfternoon / afternoonMax * 100));

        html += `
          <div class="user-card">
            <div class="user-header">
              <div class="avatar">${user.display_name?.charAt(0) || '?'}</div>
              <div class="user-name">${user.display_name || user.id}</div>
            </div>

            <div class="status-row">
              <span class="status-dot ${isActive ? 'active' : 'idle'}"></span>
              <span class="status-text">${isActive ? `æ­£åœ¨${activityName || 'è¿åŠ¨'}` : 'ä¼‘æ¯ä¸­'}</span>
              ${!freshness.fresh ? `<span class="warning">${freshness.text}</span>` : ''}
            </div>

            <div class="info-row">
              <span class="info-label">${isActive ? 'å¼€å§‹æ—¶é—´' : 'ä¼‘æ¯å¼€å§‹'}</span>
              <span class="info-value">${startedAt || '--'}</span>
            </div>
            ${isActive ? `
              <div class="info-row">
                <span class="info-label">å·²è¿›è¡Œ</span>
                <span class="info-value">${elapsedMin} åˆ†é’Ÿ</span>
              </div>
            ` : ''}

            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">ä»Šæ—¥ç§¯åˆ†</div>
                <div class="stat-value points">${todayPoints} åˆ†</div>
                ${showMoney ? `<div class="stat-value money">${pointsToMoney(todayPoints, pointsToYuan)} å…ƒ</div>` : ''}
              </div>
              <div class="stat-item">
                <div class="stat-label">æ˜¨æ—¥ç§¯åˆ†</div>
                <div class="stat-value">${yesterdayPoints} åˆ†</div>
                ${showMoney ? `<div class="stat-value money">${pointsToMoney(yesterdayPoints, pointsToYuan)} å…ƒ</div>` : ''}
              </div>
              <div class="stat-item">
                <div class="stat-label">å½“æœˆç§¯åˆ†</div>
                <div class="stat-value points">${monthPoints} åˆ†</div>
                ${showMoney ? `<div class="stat-value money">${pointsToMoney(monthPoints, pointsToYuan)} å…ƒ</div>` : ''}
              </div>
              <div class="stat-item">
                <div class="stat-label">å½“å‰æ—¶æ®µ</div>
                <div class="stat-value">${currentPeriod}</div>
              </div>
            </div>

            <div class="info-row" style="flex-direction: column; align-items: flex-start;">
              <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 4px;">
                <span class="info-label">ä»Šæ—¥ä¸Šåˆ (${morningStart}-${morningEnd})</span>
                <span class="info-value">${todayMorning}/${morningMax} åˆ† ${showMoney ? `(${pointsToMoney(todayMorning, pointsToYuan)} å…ƒ)` : ''}</span>
              </div>
              <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                <div style="width: ${morningPercent}%; height: 100%; background: ${morningPercent >= 100 ? '#4CAF50' : '#2196F3'}; border-radius: 4px;"></div>
              </div>
            </div>
            <div class="info-row" style="flex-direction: column; align-items: flex-start; margin-top: 8px;">
              <div style="display: flex; justify-content: space-between; width: 100%; margin-bottom: 4px;">
                <span class="info-label">ä»Šæ—¥ä¸‹åˆ (${afternoonStart}-${afternoonEnd})</span>
                <span class="info-value">${todayAfternoon}/${afternoonMax} åˆ† ${showMoney ? `(${pointsToMoney(todayAfternoon, pointsToYuan)} å…ƒ)` : ''}</span>
              </div>
              <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                <div style="width: ${afternoonPercent}%; height: 100%; background: ${afternoonPercent >= 100 ? '#4CAF50' : '#2196F3'}; border-radius: 4px;"></div>
              </div>
            </div>

            ${userPersons.length > 0 ? `
              <div class="persons-section">
                <div class="persons-title">åˆ†é…äººå‘˜ï¼š</div>
                <div>
                  ${userPersons.map(p => `<span class="person-tag">${p.person_name}</span>`).join('')}
                </div>
              </div>
              <div class="share-section">
                <div class="share-title">åˆ†è´¦æ˜ç»†ï¼š</div>
                ${userPersons.map(p => {
                  const eachTodayPoints = Math.floor(todayPoints / userPersons.length);
                  const eachMonthPoints = Math.floor(monthPoints / userPersons.length);
                  const eachTodayMoney = pointsToMoney(eachTodayPoints, pointsToYuan);
                  const eachMonthMoney = pointsToMoney(eachMonthPoints, pointsToYuan);
                  return `
                    <div class="share-item">
                      <span class="share-name">${p.person_name}</span>
                      <span class="share-detail">ä»Šæ—¥ ${eachTodayMoney} å…ƒ | æœ¬æœˆ ${eachMonthMoney} å…ƒ</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}

            <div class="sync-time">
              <div class="sync-time-row">
                <span class="sync-time-label">Appæ—¶é—´ï¼š</span>
                <span>${status.app_time ? (new Date().toISOString().split('T')[0] + ' ' + status.app_time) : '--'}</span>
              </div>
              <div class="sync-time-row">
                <span class="sync-time-label">æœåŠ¡å™¨åŒæ­¥ï¼š</span>
                <span>${formatTime(status.updated_at)}</span>
              </div>
            </div>
          </div>
        `;
      }

      content.innerHTML = html;
    }

    function renderHistory() {
      const content = document.getElementById('history-content');
      if (!cachedData) {
        content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        return;
      }

      const { users, dailyRecords, allActivities } = cachedData;
      const today = new Date().toISOString().split('T')[0];

      // è·å–å½“å‰ç”¨æˆ·çš„é…ç½®
      const currentUser = users.find(u => u.id === currentUserId);
      const pointsToYuan = currentUser?.points_to_yuan || 100;

      let html = `
        <div class="user-card">
          <div class="user-select">
            <select onchange="currentUserId = this.value; renderHistory();">
              ${users.map(u => `<option value="${u.id}" ${u.id === currentUserId ? 'selected' : ''}>${u.display_name || u.id}</option>`).join('')}
            </select>
          </div>

          <div class="history-header">
            <div class="month-nav">
              <button class="month-nav-btn" onclick="changeMonth(-1)">â—€</button>
              <span class="month-title">${currentMonth.substring(0, 4)}å¹´${parseInt(currentMonth.substring(5))}æœˆ</span>
              <button class="month-nav-btn" onclick="changeMonth(1)">â–¶</button>
            </div>
          </div>
      `;

      const userActivities = allActivities.filter(a => a.user_id === currentUserId && a.date.startsWith(currentMonth));
      const userDailyRecords = dailyRecords.filter(r => r.user_id === currentUserId && r.date.startsWith(currentMonth));

      const dailyData = {};
      userDailyRecords.forEach(r => {
        dailyData[r.date] = {
          morning: r.morning_points || 0,
          afternoon: r.afternoon_points || 0
        };
      });

      const sortedDates = Object.keys(dailyData).sort((a, b) => b.localeCompare(a));

      let monthTotal = 0;
      sortedDates.forEach(d => {
        monthTotal += dailyData[d].morning + dailyData[d].afternoon;
      });

      html += `
          <div class="month-summary">
            <div class="month-summary-item">
              <span class="month-summary-label">æœ¬æœˆæ€»ç§¯åˆ†</span>
              <span class="month-summary-value">${monthTotal} åˆ†</span>
            </div>
            <div class="month-summary-item">
              <span class="month-summary-label">æœ¬æœˆæ€»é‡‘é¢</span>
              <span class="month-summary-value money">${pointsToMoney(monthTotal, pointsToYuan)} å…ƒ</span>
            </div>
          </div>

          <table class="history-table">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>ä¸Šåˆ</th>
                <th>ä¸‹åˆ</th>
                <th>åˆè®¡</th>
                <th>é‡‘é¢</th>
              </tr>
            </thead>
            <tbody>
      `;

      if (sortedDates.length === 0) {
        html += '<tr><td colspan="5" style="color:#999;padding:20px;">æš‚æ— æ•°æ®</td></tr>';
      } else {
        sortedDates.forEach(date => {
          const d = dailyData[date];
          const total = d.morning + d.afternoon;
          const isToday = date === today;

          html += `
            <tr class="${isToday ? 'today' : ''}">
              <td class="date-col">${date.substring(5)}${isToday ? ' (ä»Šæ—¥)' : ''}</td>
              <td class="points-col">${d.morning}</td>
              <td class="points-col">${d.afternoon}</td>
              <td class="points-col">${total}</td>
              <td class="money-col">${pointsToMoney(total, pointsToYuan)}</td>
            </tr>
          `;
        });
      }

      html += `
            </tbody>
          </table>
        </div>
      `;

      content.innerHTML = html;
    }

    function changeMonth(delta) {
      const [year, month] = currentMonth.split('-').map(Number);
      let newMonth = month + delta;
      let newYear = year;
      
      if (newMonth > 12) {
        newMonth = 1;
        newYear++;
      } else if (newMonth < 1) {
        newMonth = 12;
        newYear--;
      }
      
      currentMonth = `${newYear}-${String(newMonth).padStart(2, '0')}`;
      renderHistory();
    }

    function renderSettings() {
      const content = document.getElementById('settings-content');
      if (!cachedData) {
        content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        return;
      }

      let html = `
        <div class="admin-tabs" style="display: flex; gap: 0; margin-bottom: 0; border-bottom: 1px solid #ddd;">
          <button class="admin-tab-btn ${settingsTab === 'users' ? 'active' : ''}" onclick="switchSettingsTab('users', event)">ç”¨æˆ·é…ç½®</button>
          <button class="admin-tab-btn ${settingsTab === 'persons' ? 'active' : ''}" onclick="switchSettingsTab('persons', event)">åˆ†è´¦äººå‘˜ç®¡ç†</button>
          <button class="admin-tab-btn ${settingsTab === 'templates' ? 'active' : ''}" onclick="switchSettingsTab('templates', event)">ä»»åŠ¡æ¨¡æ¿</button>
          <button class="admin-tab-btn ${settingsTab === 'prompts' ? 'active' : ''}" onclick="switchSettingsTab('prompts', event)">æç¤ºè¯­</button>
        </div>
        <div id="settings-panel" style="padding-top: 16px;"></div>
      `;

      content.innerHTML = html;
      loadSettingsPanel();
    }

    function switchSettingsTab(tab, evt) {
      settingsTab = tab;
      // æ›´æ–°æŒ‰é’®æ ·å¼
      document.querySelectorAll('#settings-content .admin-tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      if (evt && evt.target) {
        evt.target.classList.add('active');
      }
      loadSettingsPanel();
    }
    
    async function loadSettingsPanel() {
      const panel = document.getElementById('settings-panel');
      if (!panel) return;
      
      if (settingsTab === 'users') {
        renderUsersPanel(panel);
      } else if (settingsTab === 'persons') {
        renderPersonsPanel(panel);
      } else if (settingsTab === 'templates') {
        renderTemplatesPanel(panel);
      } else {
        renderPromptsPanel(panel);
      }
    }
    
    // ========== ç”¨æˆ·é…ç½® Tab ==========
    function renderUsersPanel(panel) {
      const { users } = cachedData;

      let html = `
        <div class="settings-section">
          <div class="settings-title">ç”¨æˆ·åˆ—è¡¨ <button onclick="showAddUserModal()" style="float: right; padding: 6px 12px; font-size: 14px;">+ æ–°å¢ç”¨æˆ·</button></div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>è®¾å¤‡ç¼–å·</th>
                <th>æ˜¾ç¤ºåç§°</th>
                <th class="hide-mobile">æ—¶æ®µé…ç½®</th>
                <th class="hide-mobile">ç»‘å®šçŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(u => {
                const userPersons = cachedData.persons?.filter(p => p.user_id === u.id) || [];
                return `
                  <tr>
                    <td>${u.id}</td>
                    <td>${u.display_name || '-'}</td>
                    <td class="hide-mobile" style="font-size: 12px;">
                      ä¸Šåˆ: ${u.morning_start || '08:00'}-${u.morning_end || '11:30'}<br>
                      ä¸‹åˆ: ${u.afternoon_start || '14:00'}-${u.afternoon_end || '18:00'}
                    </td>
                    <td class="hide-mobile">${u.device_token ? '<span style="color: #4CAF50;">å·²ç»‘å®š</span>' : '<span style="color: #FF9800;">æœªç»‘å®š</span>'}</td>
                    <td>
                      <button onclick="showEditUserModal('${u.id}')" style="padding: 4px 8px; font-size: 12px;">ç¼–è¾‘</button>
                      ${u.device_token ? `<button onclick="currentUserId='${u.id}'; document.getElementById('unbind-modal').classList.add('show')" style="padding: 4px 8px; font-size: 12px; background: #ff9800; color: white;">è§£ç»‘</button>` : ''}
                      ${u.device_token ? `<button onclick="currentUserId='${u.id}'; document.getElementById('clear-data-modal').classList.add('show')" style="padding: 4px 8px; font-size: 12px; background: #ff9800; color: white;">æ¸…é™¤</button>` : ''}
                      <button onclick="showDeleteUserModal('${u.id}')" style="padding: 4px 8px; font-size: 12px; background: #f44336; color: white;">åˆ é™¤</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      panel.innerHTML = html;
    }
    
    function showDeleteUserModal(userId) {
      const user = cachedData.users.find(u => u.id === userId);
      const displayName = user?.display_name || userId;
      
      const html = `
        <div class="modal show" id="delete-user-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">åˆ é™¤ç”¨æˆ·ç¡®è®¤</div>
            <div style="margin: 16px 0; color: #f44336; font-weight: bold;">
              âš ï¸ å³å°†åˆ é™¤ç”¨æˆ·ï¼š${displayName}ï¼ˆ${userId}ï¼‰
            </div>
            <div style="margin: 12px 0; color: #666; font-size: 14px;">
              æ­¤æ“ä½œå°†åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š<br>
              - ç”¨æˆ·é…ç½®<br>
              - æ¯æ—¥è®°å½•<br>
              - æ´»åŠ¨æ˜ç»†<br>
              - ç»‘å®šäººå‘˜<br>
              - è®¾å¤‡çŠ¶æ€<br>
              <br>åˆ é™¤åæ— æ³•æ¢å¤ï¼
            </div>
            <div style="margin: 12px 0;">
              <label>è¯·è¾“å…¥åˆ é™¤å¯†ç ï¼š</label>
              <input type="password" id="delete-password" style="width: 150px; padding: 8px;">
            </div>
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('delete-user-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" style="background: #f44336;" onclick="deleteUser('${userId}')">ç¡®è®¤åˆ é™¤</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    async function deleteUser(userId) {
      const password = document.getElementById('delete-password').value;
      if (!password) {
        alert('è¯·è¾“å…¥åˆ é™¤å¯†ç ');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/delete_user`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            p_user_id: userId,
            p_password: password
          })
        });
        
        const result = await res.json();
        
        if (result.success) {
          alert('åˆ é™¤æˆåŠŸï¼');
          document.getElementById('delete-user-modal').remove();
          await loadData();
          renderUsersPanel(document.getElementById('settings-panel'));
        } else {
          alert(result.message || 'åˆ é™¤å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }

    // ========== åˆ†è´¦äººå‘˜ç®¡ç† Tab ==========
    function renderPersonsPanel(panel) {
      const { users, persons } = cachedData;
      
      let html = `
        <div class="settings-section">
          <div class="settings-title">åˆ†è´¦äººå‘˜ç®¡ç† <button onclick="forceSyncPersons()" style="float: right; padding: 6px 12px; font-size: 14px;">å¼ºåˆ¶åŒæ­¥</button></div>
          <div style="color: #666; margin-bottom: 16px; font-size: 14px;">
            æç¤ºï¼šåˆ†è´¦äººå‘˜ç”¨äºåœ¨Appç«¯æŒ‰äººå‘˜ç»Ÿè®¡ç§¯åˆ†å’Œé‡‘é¢ã€‚ä¸è®¾ç½®åˆ†è´¦äººå‘˜ä¹Ÿå¯æ­£å¸¸ä½¿ç”¨Appã€‚ä¿®æ”¹åAppç«¯ä¼šè‡ªåŠ¨åŒæ­¥ã€‚
          </div>
      `;
      
      for (const user of users) {
        const userPersons = (persons || []).filter(p => p.user_id === user.id);
        html += `
          <div style="border: 1px solid #eee; border-radius: 8px; margin-bottom: 16px; padding: 12px;">
            <div style="font-weight: bold; margin-bottom: 8px; display: flex; justify-content: space-between;">
              <span>${user.display_name || user.id}</span>
              <button onclick="addPerson('${user.id}')" style="padding: 4px 8px; font-size: 12px;">+ æ·»åŠ äººå‘˜</button>
            </div>
            <div id="persons-list-${user.id}" style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${userPersons.length === 0 ? '<span style="color: #999;">æš‚æ— äººå‘˜</span>' : 
                userPersons.map(p => `
                  <div style="background: #e3f2fd; padding: 6px 12px; border-radius: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>${p.person_name}</span>
                    <button onclick="editPerson('${user.id}', ${p.person_index}, '${p.person_name}')" style="background: none; border: none; cursor: pointer; color: #1976D2;">âœï¸</button>
                    <button onclick="deletePerson('${user.id}', ${p.person_index})" style="background: none; border: none; cursor: pointer; color: #f44336;">ğŸ—‘ï¸</button>
                  </div>
                `).join('')}
            </div>
          </div>
        `;
      }
      
      html += '</div>';
      panel.innerHTML = html;
    }
    
    async function addPerson(userId) {
      const name = prompt('è¯·è¾“å…¥äººå‘˜å§“åï¼š');
      if (!name || !name.trim()) return;
      
      try {
        const userPersons = (cachedData.persons || []).filter(p => p.user_id === userId);
        const nextIndex = userPersons.length > 0 ? Math.max(...userPersons.map(p => p.person_index)) + 1 : 0;
        
        await fetch(`${SUPABASE_URL}/rest/v1/persons`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            user_id: userId,
            person_index: nextIndex,
            person_name: name.trim()
          })
        });
        
        await updatePersonsTimestamp(userId);
        await loadData();
        renderPersonsPanel(document.getElementById('settings-panel'));
        alert('æ·»åŠ æˆåŠŸï¼');
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    async function editPerson(userId, personIndex, oldName) {
      const name = prompt('è¯·è¾“å…¥æ–°å§“åï¼š', oldName);
      if (!name || !name.trim()) return;
      
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/persons?user_id=eq.${userId}&person_index=eq.${personIndex}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ person_name: name.trim() })
        });
        
        await updatePersonsTimestamp(userId);
        await loadData();
        renderPersonsPanel(document.getElementById('settings-panel'));
        alert('ä¿®æ”¹æˆåŠŸï¼');
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    async function deletePerson(userId, personIndex) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤äººå‘˜å—ï¼Ÿ')) return;
      
      try {
        await fetch(`${SUPABASE_URL}/rest/v1/persons?user_id=eq.${userId}&person_index=eq.${personIndex}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Prefer': 'return=minimal'
          }
        });
        
        await updatePersonsTimestamp(userId);
        await loadData();
        renderPersonsPanel(document.getElementById('settings-panel'));
        alert('åˆ é™¤æˆåŠŸï¼');
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    async function updatePersonsTimestamp(userId) {
      const now = new Date().toISOString();
      await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ persons_updated_at: now })
      });
    }
    
    async function forceSyncPersons() {
      if (!confirm('ç¡®å®šè¦å¼ºåˆ¶åŒæ­¥äººå‘˜æ•°æ®å—ï¼Ÿè¿™å°†åˆ·æ–°æ‰€æœ‰ç”¨æˆ·çš„ persons_updated_atï¼Œè§¦å‘æ‰€æœ‰ App ç«¯é‡æ–°åŒæ­¥äººå‘˜æ•°æ®ã€‚')) return;
      
      const now = new Date().toISOString();
      const { users } = cachedData;
      
      for (const user of users) {
        await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${user.id}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ persons_updated_at: now })
        });
      }
      
      alert('å¼ºåˆ¶åŒæ­¥æˆåŠŸï¼');
    }

    // ========== ä»»åŠ¡æ¨¡æ¿ Tab ==========
    async function renderTemplatesPanel(panel) {
      panel.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/task_templates?order=task_type`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        cachedTemplates = await res.json();
      } catch (e) {
        console.error('load templates error:', e);
        cachedTemplates = [];
      }
      
      const taskNames = {
        'walk': 'æ•£æ­¥', 'step': 'æ‘†æ‰‹è‡‚', 'stand': 'ä¸¾æ‰‹æ”¾ä¸‹',
        'turn_head': 'è½¬å¤´', 'raise_hand': 'ä¸¾æ‰‹', 'clap': 'é¼“æŒ',
        'breath': 'æ·±å‘¼å¸', 'say_good': 'è¯´"å¥½"'
      };
      
      let html = `
        <div class="settings-section">
          <div class="settings-title">ä»»åŠ¡æ¨¡æ¿é…ç½® <button onclick="forceSyncTemplates()" style="float: right; padding: 6px 12px; font-size: 14px;">å¼ºåˆ¶åŒæ­¥</button></div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>ä»»åŠ¡ç±»å‹</th>
                <th>åç§°</th>
                <th>æ—¶é•¿/æ¬¡æ•°</th>
                <th>ç§¯åˆ†</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${cachedTemplates.map(t => `
                <tr>
                  <td>${t.task_type}</td>
                  <td>${t.task_name || taskNames[t.task_type] || '-'}</td>
                  <td>${t.task_type === 'say_good' ? (t.count || 0) + 'æ¬¡' : (t.duration || 0) + 'åˆ†é’Ÿ'}</td>
                  <td>${t.points || 0}</td>
                  <td><button onclick="showEditTemplateModal('${t.task_type}')" style="padding: 4px 8px; font-size: 12px;">ç¼–è¾‘</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      panel.innerHTML = html;
    }
    
    async function forceSyncTemplates() {
      if (!confirm('ç¡®å®šè¦å¼ºåˆ¶åŒæ­¥ä»»åŠ¡æ¨¡æ¿å—ï¼Ÿè¿™å°†åˆ·æ–°æ‰€æœ‰ç”¨æˆ·çš„ task_templates_updated_atï¼Œè§¦å‘æ‰€æœ‰ App ç«¯é‡æ–°åŒæ­¥ä»»åŠ¡æ¨¡æ¿æ•°æ®ã€‚')) return;
      
      const now = new Date().toISOString();
      await fetch(`${SUPABASE_URL}/rest/v1/users`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ task_templates_updated_at: now })
      });
      
      alert('å¼ºåˆ¶åŒæ­¥æˆåŠŸï¼');
    }

    // ========== æç¤ºè¯­ Tab ==========
    async function renderPromptsPanel(panel) {
      panel.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/global_prompts?order=key`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        cachedGlobalPrompts = await res.json();
      } catch (e) {
        console.error('load prompts error:', e);
        cachedGlobalPrompts = [];
      }
      
      let html = `
        <div class="settings-section">
          <div class="settings-title">å…¨å±€æç¤ºè¯­ <button onclick="forceSyncPrompts()" style="float: right; padding: 6px 12px; font-size: 14px;">å¼ºåˆ¶åŒæ­¥</button></div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>é”®</th>
                <th>å†…å®¹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${cachedGlobalPrompts.map(p => `
                <tr>
                  <td>${p.key}</td>
                  <td style="font-size: 13px; max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${p.value}</td>
                  <td><button onclick="showEditPromptModal('${p.key}')" style="padding: 4px 8px; font-size: 12px;">ç¼–è¾‘</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      panel.innerHTML = html;
    }
    
    async function forceSyncPrompts() {
      if (!confirm('ç¡®å®šè¦å¼ºåˆ¶åŒæ­¥æç¤ºè¯­å—ï¼Ÿè¿™å°†åˆ·æ–°æ‰€æœ‰ç”¨æˆ·çš„ global_prompts_updated_atï¼Œè§¦å‘æ‰€æœ‰ App ç«¯é‡æ–°åŒæ­¥æç¤ºè¯­æ•°æ®ã€‚')) return;
      
      const now = new Date().toISOString();
      await fetch(`${SUPABASE_URL}/rest/v1/users`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify({ global_prompts_updated_at: now })
      });
      
      alert('å¼ºåˆ¶åŒæ­¥æˆåŠŸï¼');
    }
    

    // éšè—è®¾ç½®åŠŸèƒ½ï¼šè¿ç»­ç‚¹å‡»æ ‡é¢˜5æ¬¡æ˜¾ç¤º/éšè—è®¾ç½®æ ‡ç­¾
    let titleClickCount = 0;
    let titleClickTimer = null;
    let settingsVisible = false;
    
    document.getElementById('main-title').addEventListener('click', function() {
      titleClickCount++;
      
      if (titleClickTimer) {
        clearTimeout(titleClickTimer);
      }
      
      titleClickTimer = setTimeout(function() {
        titleClickCount = 0;
      }, 2000);
      
      if (titleClickCount >= 5) {
        settingsVisible = !settingsVisible;
        const settingsTab = document.getElementById('settings-tab');
        if (settingsVisible) {
          settingsTab.classList.remove('hidden');
        } else {
          settingsTab.classList.add('hidden');
          if (document.getElementById('settings-content').classList.contains('hidden') === false) {
            switchTab('realtime');
          }
        }
        titleClickCount = 0;
      }
    });

    // ========== å¼¹çª— ==========
    let cachedTemplates = [];
    let cachedGlobalPrompts = [];
    
    // æ–°å¢ç”¨æˆ·å¼¹çª—
    function showAddUserModal() {
      const html = `
        <div class="modal show" id="add-user-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-title">æ–°å¢ç”¨æˆ·</div>
            <div style="margin-bottom: 12px;">
              <label>è®¾å¤‡ç¼–å·ï¼š</label>
              <input type="text" id="new-user-id" style="width: 100px; padding: 8px;" placeholder="å¦‚ 001">
            </div>
            <div style="margin-bottom: 12px;">
              <label>æ˜¾ç¤ºåç§°ï¼š</label>
              <input type="text" id="new-user-name" style="width: 150px; padding: 8px;" placeholder="å§“å">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸Šåˆæ—¶æ®µï¼š</label>
              <input type="time" id="new-morning-start" value="08:00" style="padding: 6px;"> - 
              <input type="time" id="new-morning-end" value="11:30" style="padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸‹åˆæ—¶æ®µï¼š</label>
              <input type="time" id="new-afternoon-start" value="14:00" style="padding: 6px;"> - 
              <input type="time" id="new-afternoon-end" value="18:00" style="padding: 6px;">
            </div>
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('add-user-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="createUser()">åˆ›å»º</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    async function createUser() {
      const id = document.getElementById('new-user-id').value.trim();
      const displayName = document.getElementById('new-user-name').value.trim();
      const morningStart = document.getElementById('new-morning-start').value;
      const morningEnd = document.getElementById('new-morning-end').value;
      const afternoonStart = document.getElementById('new-afternoon-start').value;
      const afternoonEnd = document.getElementById('new-afternoon-end').value;
      
      if (!id) {
        alert('è¯·è¾“å…¥è®¾å¤‡ç¼–å·');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            id: id,
            display_name: displayName,
            morning_start: morningStart,
            morning_end: morningEnd,
            afternoon_start: afternoonStart,
            afternoon_end: afternoonEnd,
            task_order: 'walk,step,stand,turn_head,raise_hand,clap,breath,say_good',
            morning_max_points: 1500,
            afternoon_max_points: 1500,
            show_money: true,
            points_to_yuan: 100,
            say_good_enabled: true,
            debug_mode: false
          })
        });
        
        if (res.ok) {
          alert('åˆ›å»ºæˆåŠŸï¼');
          document.getElementById('add-user-modal').remove();
          await loadData();
          renderUsersPanel(document.getElementById('settings-panel'));
        } else {
          const err = await res.text();
          alert('åˆ›å»ºå¤±è´¥ï¼š' + err);
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // ç¼–è¾‘ç”¨æˆ·å¼¹çª—
    async function showEditUserModal(userId) {
      const user = cachedData.users.find(u => u.id === userId);
      if (!user) return;
      
      const taskTypes = ['walk', 'step', 'stand', 'turn_head', 'raise_hand', 'clap', 'breath', 'say_good'];
      const taskNames = {
        'walk': 'æ•£æ­¥', 'step': 'æ‘†æ‰‹è‡‚', 'stand': 'ä¸¾æ‰‹æ”¾ä¸‹',
        'turn_head': 'è½¬å¤´', 'raise_hand': 'ä¸¾æ‰‹', 'clap': 'é¼“æŒ',
        'breath': 'æ·±å‘¼å¸', 'say_good': 'è¯´"å¥½"'
      };
      const currentOrder = (user.task_order || taskTypes.join(',')).split(',');
      
      const html = `
        <div class="modal show" id="edit-user-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
            <div class="modal-title" style="flex-shrink: 0;">ç¼–è¾‘ç”¨æˆ· - ${userId}</div>
            <div class="modal-body-scroll">
              <!-- åŸºæœ¬è®¾ç½®æŠ½å±‰ -->
              <div class="drawer" id="user-basic-drawer">
                <div class="drawer-header" onclick="toggleDrawer('user-basic-drawer')">
                  <span>ğŸ“‹ åŸºæœ¬è®¾ç½®</span>
                  <span class="drawer-arrow">â–¼</span>
                </div>
                <div class="drawer-content">
                  <div style="margin-bottom: 12px;">
                    <label>æ˜¾ç¤ºåç§°ï¼š</label>
                    <input type="text" id="edit-display-name" value="${user.display_name || ''}" style="width: 150px; padding: 8px;">
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label>ä¸Šåˆæ—¶æ®µï¼š</label>
                    <input type="time" id="edit-morning-start" value="${user.morning_start || '08:00'}" style="padding: 6px;"> - 
                    <input type="time" id="edit-morning-end" value="${user.morning_end || '11:30'}" style="padding: 6px;">
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label>ä¸‹åˆæ—¶æ®µï¼š</label>
                    <input type="time" id="edit-afternoon-start" value="${user.afternoon_start || '14:00'}" style="padding: 6px;"> - 
                    <input type="time" id="edit-afternoon-end" value="${user.afternoon_end || '18:00'}" style="padding: 6px;">
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label>ä¸Šåˆæœ€å¤§ç§¯åˆ†ï¼š</label>
                    <input type="number" id="edit-morning-max" value="${user.morning_max_points || 1500}" style="width: 80px; padding: 6px;">
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label>ä¸‹åˆæœ€å¤§ç§¯åˆ†ï¼š</label>
                    <input type="number" id="edit-afternoon-max" value="${user.afternoon_max_points || 1500}" style="width: 80px; padding: 6px;">
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label>ç§¯åˆ†å…‘æ¢æ¯”ä¾‹ï¼š</label>
                    <input type="number" id="edit-points-to-yuan" value="${user.points_to_yuan || 100}" style="width: 80px; padding: 6px;"> ç§¯åˆ† = 1å…ƒ
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label><input type="checkbox" id="edit-show-money" ${user.show_money !== false ? 'checked' : ''}> æ˜¾ç¤ºé‡‘é¢</label>
                    <label style="margin-left: 16px;"><input type="checkbox" id="edit-debug-mode" ${user.debug_mode ? 'checked' : ''}> è°ƒè¯•æ¨¡å¼</label>
                  </div>
                </div>
              </div>
              
              <!-- ä»»åŠ¡é¡ºåºæŠ½å±‰ -->
              <div class="drawer collapsed" id="user-task-drawer">
                <div class="drawer-header" onclick="toggleDrawer('user-task-drawer')">
                  <span>ğŸ”„ ä»»åŠ¡é¡ºåº</span>
                  <span class="drawer-arrow">â–¼</span>
                </div>
                <div class="drawer-content">
                  <div style="margin-bottom: 8px; color: #666; font-size: 13px;">
                    å‹¾é€‰å¯ç”¨ï¼Œ<span style="color:#1976d2;">é•¿æŒ‰</span>æ‹–æ‹½æ’åº
                  </div>
                  <div id="task-order-list">
                    ${currentOrder.map((t, idx) => `
                      <div class="task-order-item" data-task="${t}" draggable="true" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; background: #f5f5f5; border-radius: 4px; cursor: move; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;">
                        <input type="checkbox" class="task-enabled" value="${t}" checked onchange="updateTaskOrderFromList()" style="margin-right: 8px;">
                        <span class="drag-handle" style="color: #999; margin-right: 8px;">â˜°</span>
                        <span class="task-name">${taskNames[t] || t}</span>
                      </div>
                    `).join('')}
                    ${taskTypes.filter(t => !currentOrder.includes(t)).map(t => `
                      <div class="task-order-item" data-task="${t}" draggable="true" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; background: #fff; border: 1px dashed #ccc; border-radius: 4px; cursor: move; opacity: 0.6; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;">
                        <input type="checkbox" class="task-enabled" value="${t}" onchange="updateTaskOrderFromList()" style="margin-right: 8px;">
                        <span class="drag-handle" style="color: #999; margin-right: 8px;">â˜°</span>
                        <span class="task-name">${taskNames[t] || t}</span>
                      </div>
                    `).join('')}
                  </div>
                  <input type="hidden" id="edit-task-order" value="${currentOrder.join(',')}">
                </div>
              </div>
            </div>
            <div class="modal-footer-fixed" style="flex-shrink: 0;">
              <button class="modal-btn cancel" onclick="document.getElementById('edit-user-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="saveUser('${userId}')">ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      initTaskDragSort();
    }
    
    // æŠ½å±‰åˆ‡æ¢ï¼ˆæ‰‹é£ç´æ¨¡å¼ï¼šåŒä¸€å®¹å™¨å†…å§‹ç»ˆæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæ‰“å¼€ï¼‰
    function toggleDrawer(drawerId) {
      const drawer = document.getElementById(drawerId);
      if (!drawer) return;
      
      const isCurrentlyCollapsed = drawer.classList.contains('collapsed');
      
      // å¦‚æœå½“å‰æ˜¯æ”¶èµ·çŠ¶æ€ï¼Œè¦å±•å¼€å®ƒ
      if (isCurrentlyCollapsed) {
        // å…ˆå…³é—­åŒçº§å…¶ä»–æŠ½å±‰
        const siblings = drawer.parentElement.querySelectorAll('.drawer');
        siblings.forEach(sibling => {
          if (sibling !== drawer) {
            sibling.classList.add('collapsed');
          }
        });
        // ç„¶åå±•å¼€å½“å‰æŠ½å±‰
        drawer.classList.remove('collapsed');
      }
      // å¦‚æœå½“å‰æ˜¯å±•å¼€çŠ¶æ€ï¼Œä¸å…è®¸å…³é—­ï¼ˆç¡®ä¿å§‹ç»ˆæœ‰ä¸€ä¸ªæ‰“å¼€ï¼‰
    }
    
    function updateTaskOrderFromList() {
      const items = document.querySelectorAll('#task-order-list .task-order-item');
      const order = [];
      items.forEach(item => {
        const checkbox = item.querySelector('.task-enabled');
        if (checkbox && checkbox.checked) {
          order.push(item.dataset.task);
        }
      });
      document.getElementById('edit-task-order').value = order.join(',');
    }
    
    // åˆå§‹åŒ–æ‹–æ‹½æ’åºï¼ˆæ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸ï¼‰
    function initTaskDragSort() {
      const list = document.getElementById('task-order-list');
      if (!list) return;

      let draggedItem = null;
      let touchStartY = 0;
      let touchStartX = 0;
      let isDragging = false;
      let longPressTimer = null;
      let placeholder = null;

      list.querySelectorAll('.task-order-item').forEach(item => {
        // é¼ æ ‡æ‹–æ‹½äº‹ä»¶
        item.addEventListener('dragstart', function(e) {
          draggedItem = this;
          this.style.opacity = '0.5';
        });

        item.addEventListener('dragend', function(e) {
          this.style.opacity = '';
          updateTaskOrderFromList();
        });

        item.addEventListener('dragover', function(e) {
          e.preventDefault();
          const afterElement = getDragAfterElement(list, e.clientY);
          if (afterElement == null) {
            list.appendChild(draggedItem);
          } else {
            list.insertBefore(draggedItem, afterElement);
          }
        });

        // è§¦æ‘¸äº‹ä»¶ï¼ˆæ‰‹æœºç«¯ï¼‰- é•¿æŒ‰å¼€å§‹æ‹–æ‹½
        item.addEventListener('touchstart', function(e) {
          // å¦‚æœç‚¹å‡»çš„æ˜¯checkboxï¼Œä¸å¯åŠ¨æ‹–æ‹½
          if (e.target.classList.contains('task-enabled')) {
            draggedItem = null;
            return;
          }
          
          draggedItem = this;
          touchStartY = e.touches[0].clientY;
          touchStartX = e.touches[0].clientX;
          isDragging = false;

          // é•¿æŒ‰300msåå¼€å§‹æ‹–æ‹½
          longPressTimer = setTimeout(() => {
            isDragging = true;
            draggedItem.style.opacity = '0.5';
            draggedItem.style.background = '#e3f2fd';
            draggedItem.style.transform = 'scale(1.02)';
            draggedItem.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
            if (navigator.vibrate) navigator.vibrate(50);
          }, 300);
        }, { passive: true });

        item.addEventListener('touchmove', function(e) {
          if (!draggedItem) return;

          const touch = e.touches[0];
          const moveY = Math.abs(touch.clientY - touchStartY);
          const moveX = Math.abs(touch.clientX - touchStartX);

          // ç§»åŠ¨è¶…è¿‡10pxå–æ¶ˆé•¿æŒ‰è®¡æ—¶ï¼Œé¿å…è¯¯è§¦æ‹–æ‹½
          if (!isDragging && (moveY > 10 || moveX > 10)) {
            clearTimeout(longPressTimer);
            return;
          }

          // æ­£åœ¨æ‹–æ‹½æ—¶é˜»æ­¢é¡µé¢æ»šåŠ¨å’Œæ–‡å­—é€‰æ‹©
          if (isDragging) {
            e.preventDefault();
            const afterElement = getDragAfterElement(list, touch.clientY);
            if (afterElement == null) {
              list.appendChild(draggedItem);
            } else {
              list.insertBefore(draggedItem, afterElement);
            }
            touchStartY = touch.clientY; // æ›´æ–°ä½ç½®
          }
        }, { passive: false });

        item.addEventListener('touchend', function(e) {
          clearTimeout(longPressTimer);

          if (isDragging && draggedItem === this) {
            // æ‹–æ‹½ç»“æŸï¼Œé˜»æ­¢å¯èƒ½çš„æ–‡å­—é€‰æ‹©
            e.preventDefault();
            this.style.opacity = '';
            this.style.background = '';
            this.style.transform = '';
            this.style.boxShadow = '';
            updateTaskOrderFromList();
          }

          isDragging = false;
          draggedItem = null;
        });

        item.addEventListener('touchcancel', function(e) {
          clearTimeout(longPressTimer);
          if (draggedItem) {
            draggedItem.style.opacity = '';
            draggedItem.style.background = '';
            draggedItem.style.transform = '';
            draggedItem.style.boxShadow = '';
          }
          isDragging = false;
          draggedItem = null;
        });
      });
    }
    
    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.task-order-item:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    
    async function saveUser(userId) {
      const displayName = document.getElementById('edit-display-name').value.trim();
      const morningStart = document.getElementById('edit-morning-start').value;
      const morningEnd = document.getElementById('edit-morning-end').value;
      const afternoonStart = document.getElementById('edit-afternoon-start').value;
      const afternoonEnd = document.getElementById('edit-afternoon-end').value;
      const morningMax = parseInt(document.getElementById('edit-morning-max').value) || 1500;
      const afternoonMax = parseInt(document.getElementById('edit-afternoon-max').value) || 1500;
      const pointsToYuan = parseInt(document.getElementById('edit-points-to-yuan').value) || 100;
      const showMoney = document.getElementById('edit-show-money').checked;
      const debugMode = document.getElementById('edit-debug-mode').checked;
      const taskOrder = document.getElementById('edit-task-order').value;
      // æ ¹æ®ä»»åŠ¡é¡ºåºä¸­æ˜¯å¦åŒ…å« say_good æ¥å†³å®šæ˜¯å¦å¯ç”¨
      const sayGoodEnabled = taskOrder.includes('say_good');
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            display_name: displayName,
            morning_start: morningStart,
            morning_end: morningEnd,
            afternoon_start: afternoonStart,
            afternoon_end: afternoonEnd,
            morning_max_points: morningMax,
            afternoon_max_points: afternoonMax,
            points_to_yuan: pointsToYuan,
            show_money: showMoney,
            debug_mode: debugMode,
            say_good_enabled: sayGoodEnabled,
            task_order: taskOrder,
            updated_at: new Date().toISOString()
          })
        });
        
        if (res.ok) {
          alert('ä¿å­˜æˆåŠŸï¼Appç«¯ä¸‹æ¬¡å¯åŠ¨æ—¶å°†è‡ªåŠ¨åŒæ­¥ã€‚');
          document.getElementById('edit-user-modal').remove();
          await loadData();
          renderUsersPanel(document.getElementById('settings-panel'));
        } else {
          alert('ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // è§£ç»‘è®¾å¤‡
    function closeUnbindModal() {
      document.getElementById('unbind-modal').classList.remove('show');
      document.getElementById('unbind-password-input').value = '';
    }
    
    async function confirmUnbind() {
      const password = document.getElementById('unbind-password-input').value;
      if (password !== ADMIN_PASSWORD) {
        alert('å¯†ç é”™è¯¯');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${currentUserId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            device_token: null,
            updated_at: new Date().toISOString()
          })
        });
        
        if (res.ok) {
          alert('è§£ç»‘æˆåŠŸï¼');
          closeUnbindModal();
          document.getElementById('edit-user-modal')?.remove();
          await loadData();
          renderUsersPanel(document.getElementById('settings-panel'));
        } else {
          alert('è§£ç»‘å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // æ¸…é™¤ç”¨æˆ·æ‰€æœ‰æ•°æ®
    function closePasswordModal() {
      document.getElementById('clear-data-modal').classList.remove('show');
      document.getElementById('clear-password-input').value = '';
    }
    
    async function confirmClearData() {
      const password = document.getElementById('clear-password-input').value;
      if (password !== ADMIN_PASSWORD) {
        alert('å¯†ç é”™è¯¯');
        return;
      }
      
      if (!confirm('ç¡®å®šè¦æ¸…é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }
      
      try {
        // åˆ é™¤æ¯æ—¥è®°å½•
        await fetch(`${SUPABASE_URL}/rest/v1/daily_records?user_id=eq.${currentUserId}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Prefer': 'return=minimal'
          }
        });
        
        // åˆ é™¤æ´»åŠ¨æ˜ç»†
        await fetch(`${SUPABASE_URL}/rest/v1/activities?user_id=eq.${currentUserId}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Prefer': 'return=minimal'
          }
        });
        
        alert('æ•°æ®æ¸…é™¤æˆåŠŸï¼');
        closePasswordModal();
        document.getElementById('edit-user-modal')?.remove();
        await loadData();
        renderUsersPanel(document.getElementById('settings-panel'));
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // ç¼–è¾‘ä»»åŠ¡æ¨¡æ¿å¼¹çª—
    let templateTitleClickCount = 0;
    let templateTitleClickTimer = null;
    let advancedParamsVisible = false;
    
    function showEditTemplateModal(taskType) {
      const template = cachedTemplates.find(t => t.task_type === taskType);
      if (!template) return;
      
      const promptConfig = template.prompt_config || {};
      const taskIntro = promptConfig.task_intro || '';
      const tooFast = promptConfig.too_fast || 'å¤ªå¿«äº†ï¼Œè¯·æ…¢ä¸€ç‚¹';
      const paused = promptConfig.paused || 'è¯·ç»§ç»­';
      const inProgress = promptConfig.in_progress || '';
      const completed = promptConfig.completed || 'å¤ªå¥½äº†ï¼Œè·å¾—{points}ç§¯åˆ†';
      const progress = promptConfig.progress || '';
      
      // æ ¹æ®ä»»åŠ¡ç±»å‹å†³å®šæ˜¾ç¤ºæ¬¡æ•°è¿˜æ˜¯æ—¶é•¿
      const isSayGood = taskType === 'say_good';
      const durationOrCountLabel = isSayGood ? 'æ¬¡æ•°ï¼š' : 'æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š';
      const durationOrCountValue = isSayGood ? (template.count || 0) : (template.duration || 0);
      const durationOrCountId = isSayGood ? 'template-count' : 'template-duration';
      const durationOrCountPlaceholder = isSayGood ? 'å¦‚ 10' : 'å¦‚ 5';
      
      // é‡ç½®é«˜çº§å‚æ•°æ˜¾ç¤ºçŠ¶æ€
      advancedParamsVisible = false;
      
      const html = `
        <div class="modal show" id="template-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 550px; max-height: 85vh; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
            <div class="modal-title" id="template-modal-title" style="flex-shrink: 0; cursor: pointer; user-select: none;">ç¼–è¾‘ä»»åŠ¡æ¨¡æ¿ - ${taskType}</div>
            <div class="modal-body-scroll">
              <!-- åŸºæœ¬è®¾ç½®æŠ½å±‰ -->
              <div class="drawer" id="template-basic-drawer">
                <div class="drawer-header" onclick="toggleDrawer('template-basic-drawer')">
                  <span>ğŸ“‹ åŸºæœ¬è®¾ç½®</span>
                  <span class="drawer-arrow">â–¼</span>
                </div>
                <div class="drawer-content">
                  <div style="margin-bottom: 12px;">
                    <label>ä»»åŠ¡åç§°ï¼š</label>
                    <input type="text" id="template-name" value="${template.task_name || ''}" style="width: 150px; padding: 8px;">
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label>${durationOrCountLabel}</label>
                    <input type="number" id="${durationOrCountId}" value="${durationOrCountValue}" style="width: 80px; padding: 6px;" placeholder="${durationOrCountPlaceholder}" onchange="updateProgressInputState()" oninput="updateProgressInputState()">
                    <input type="hidden" id="${isSayGood ? 'template-duration' : 'template-count'}" value="${isSayGood ? (template.duration || 0) : (template.count || 0)}">
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label>å›ºå®šç§¯åˆ†ï¼š</label>
                    <input type="number" id="template-points" value="${template.points || 0}" style="width: 80px; padding: 6px;">
                  </div>
                  
                  <!-- é«˜çº§å‚æ•°ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                  <div id="advanced-params-section" style="display: none;">
                    <div class="advanced-params">
                      <div class="advanced-params-header">âš™ï¸ é«˜çº§å‚æ•°ï¼ˆè¿ç»­ç‚¹å‡»æ ‡é¢˜5ä¸‹æ˜¾ç¤ºï¼‰</div>
                      <div style="margin-bottom: 12px;">
                        <label>æœ€å¤§é€Ÿåº¦é˜ˆå€¼ï¼š</label>
                        <input type="number" id="template-max-speed" value="${template.max_speed || 0}" style="width: 80px; padding: 6px;">
                      </div>
                      <div style="margin-bottom: 12px;">
                        <label>æœ€å°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼š</label>
                        <input type="number" id="template-min-interval" value="${template.min_interval || 0}" style="width: 100px; padding: 6px;">
                      </div>
                      <div style="margin-bottom: 0;">
                        <label>æš‚åœé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ï¼š</label>
                        <input type="number" id="template-pause-threshold" value="${template.pause_threshold || 0}" style="width: 100px; padding: 6px;">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- æç¤ºè¯­è®¾ç½®æŠ½å±‰ -->
              <div class="drawer collapsed" id="template-prompt-drawer">
                <div class="drawer-header" onclick="toggleDrawer('template-prompt-drawer')">
                  <span>ğŸ“¢ æç¤ºè¯­è®¾ç½®</span>
                  <span class="drawer-arrow">â–¼</span>
                </div>
                <div class="drawer-content">
                  <div style="margin-bottom: 10px;">
                    <label style="font-size: 13px; color: #666;">ä»»åŠ¡è¯´æ˜ <span style="color: #999;">({duration}=æ—¶é•¿, {count}=æ¬¡æ•°)</span>ï¼š</label><br>
                    <textarea id="prompt-intro" style="width: 100%; height: 50px; padding: 6px; font-size: 13px;">${taskIntro}</textarea>
                  </div>
                  <div style="margin-bottom: 10px;">
                    <label style="font-size: 13px; color: #666;">å¤ªå¿«æç¤ºï¼š</label><br>
                    <input type="text" id="prompt-too-fast" value="${tooFast}" style="width: 100%; padding: 6px; font-size: 13px;">
                  </div>
                  <div style="margin-bottom: 10px;">
                    <label style="font-size: 13px; color: #666;">æš‚åœæç¤ºï¼š</label><br>
                    <input type="text" id="prompt-paused" value="${paused}" style="width: 100%; padding: 6px; font-size: 13px;">
                  </div>
                  <div style="margin-bottom: 10px;">
                    <label style="font-size: 13px; color: #666;">è¿›è¡Œä¸­æç¤ºï¼š</label><br>
                    <input type="text" id="prompt-in-progress" value="${inProgress}" style="width: 100%; padding: 6px; font-size: 13px;">
                  </div>
                  <div style="margin-bottom: 10px;">
                    <label style="font-size: 13px; color: #666;">å®Œæˆæç¤º <span style="color: #999;">({points}=ç§¯åˆ†)</span>ï¼š</label><br>
                    <input type="text" id="prompt-completed" value="${completed}" style="width: 100%; padding: 6px; font-size: 13px;">
                  </div>
                  ${!isSayGood ? `
                  <div style="margin-bottom: 0;">
                    <label style="font-size: 13px; color: #666;">è¿›åº¦æç¤º <span style="color: #999;">({current}=å·²è¿›è¡Œ, {remaining}=å‰©ä½™ï¼Œæ—¶é•¿éœ€â‰¥2åˆ†é’Ÿç”Ÿæ•ˆ)</span>ï¼š</label><br>
                    <input type="text" id="prompt-progress" value="${progress}" style="width: 100%; padding: 6px; font-size: 13px;" ${durationOrCountValue < 2 ? 'disabled style="background: #f0f0f0; color: #999;"' : ''}>
                  </div>
                  ` : `<input type="hidden" id="prompt-progress" value="${progress}">`}
                </div>
              </div>
            </div>
            <div class="modal-footer-fixed" style="flex-shrink: 0;">
              <button class="modal-btn cancel" onclick="document.getElementById('template-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="saveTemplate('${taskType}')">ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
      
      // ç»‘å®šæ ‡é¢˜ç‚¹å‡»äº‹ä»¶ï¼ˆè¿ç»­ç‚¹å‡»5ä¸‹æ˜¾ç¤º/éšè—é«˜çº§å‚æ•°ï¼‰
      const titleEl = document.getElementById('template-modal-title');
      if (titleEl) {
        titleEl.addEventListener('click', function() {
          templateTitleClickCount++;
          
          if (templateTitleClickTimer) {
            clearTimeout(templateTitleClickTimer);
          }
          
          templateTitleClickTimer = setTimeout(function() {
            templateTitleClickCount = 0;
          }, 2000);
          
          if (templateTitleClickCount >= 5) {
            advancedParamsVisible = !advancedParamsVisible;
            const advancedSection = document.getElementById('advanced-params-section');
            if (advancedSection) {
              advancedSection.style.display = advancedParamsVisible ? 'block' : 'none';
            }
            templateTitleClickCount = 0;
          }
        });
      }
    }
    
    // æ›´æ–°è¿›åº¦æç¤ºè¾“å…¥æ¡†çš„ç¦ç”¨çŠ¶æ€ï¼ˆæ ¹æ®æ—¶é•¿è”åŠ¨ï¼‰
    function updateProgressInputState() {
      const progressInput = document.getElementById('prompt-progress');
      const durationInput = document.getElementById('template-duration');
      if (progressInput && durationInput) {
        const duration = parseInt(durationInput.value) || 0;
        if (duration < 2) {
          progressInput.disabled = true;
          progressInput.style.background = '#f0f0f0';
          progressInput.style.color = '#999';
        } else {
          progressInput.disabled = false;
          progressInput.style.background = '';
          progressInput.style.color = '';
        }
      }
    }
    

    async function saveTemplate(taskType) {
      const promptConfig = {
        task_intro: document.getElementById('prompt-intro').value.trim(),
        too_fast: document.getElementById('prompt-too-fast').value.trim(),
        paused: document.getElementById('prompt-paused').value.trim(),
        in_progress: document.getElementById('prompt-in-progress').value.trim(),
        completed: document.getElementById('prompt-completed').value.trim(),
        progress: document.getElementById('prompt-progress').value.trim()
      };
      
      const data = {
        task_name: document.getElementById('template-name').value.trim(),
        duration: parseInt(document.getElementById('template-duration').value) || 0,
        count: parseInt(document.getElementById('template-count').value) || 0,
        points: parseInt(document.getElementById('template-points').value) || 0,
        max_speed: parseInt(document.getElementById('template-max-speed').value) || 0,
        min_interval: parseInt(document.getElementById('template-min-interval').value) || 0,
        pause_threshold: parseInt(document.getElementById('template-pause-threshold').value) || 0,
        prompt_config: promptConfig,
        updated_at: new Date().toISOString()
      };
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/task_templates?task_type=eq.${taskType}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify(data)
        });
        
        const result = await res.json();
        
        if (res.ok && result && result.length > 0) {
          // æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„ task_templates_updated_at
          const now = new Date().toISOString();
          await fetch(`${SUPABASE_URL}/rest/v1/users`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify({ task_templates_updated_at: now })
          });
          
          alert('ä¿å­˜æˆåŠŸï¼');
          document.getElementById('template-modal').remove();
          renderTemplatesPanel(document.getElementById('settings-panel'));
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + (JSON.stringify(result) || 'æœªæ‰¾åˆ°åŒ¹é…è®°å½•'));
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // ç¼–è¾‘æç¤ºè¯­å¼¹çª—
    function showEditPromptModal(key) {
      const prompt = cachedGlobalPrompts.find(p => p.key === key);
      if (!prompt) return;
      
      const html = `
        <div class="modal show" id="prompt-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-title">ç¼–è¾‘æç¤ºè¯­ - ${key}</div>
            <div style="margin-bottom: 12px;">
              <textarea id="prompt-value" style="width: 100%; height: 100px; padding: 8px;">${prompt.value || ''}</textarea>
            </div>
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('prompt-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="savePrompt('${key}')">ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    async function savePrompt(key) {
      const value = document.getElementById('prompt-value').value.trim();
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/global_prompts?key=eq.${key}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify({ value: value, updated_at: new Date().toISOString() })
        });
        
        const result = await res.json();
        
        if (res.ok && result && result.length > 0) {
          // æ›´æ–°æ‰€æœ‰ç”¨æˆ·çš„ global_prompts_updated_at
          const now = new Date().toISOString();
          await fetch(`${SUPABASE_URL}/rest/v1/users`, {
            method: 'PATCH',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify({ global_prompts_updated_at: now })
          });
          
          alert('ä¿å­˜æˆåŠŸï¼');
          document.getElementById('prompt-modal').remove();
          renderPromptsPanel(document.getElementById('settings-panel'));
        } else {
          alert('ä¿å­˜å¤±è´¥: ' + (JSON.stringify(result) || 'æœªæ‰¾åˆ°åŒ¹é…è®°å½•'));
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      document.getElementById('config-name').textContent = CLOUD_CONFIG.name;
      document.getElementById('realtime-content').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      await loadData();
      renderRealtime();
    }

    init();
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
