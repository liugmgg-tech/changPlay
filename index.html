<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¿åŠ¨æŸ¥çœ‹</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h1 { font-size: 24px; margin-bottom: 20px; color: #333; }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      background: white;
      border: none;
      font-size: 16px;
      color: #666;
      transition: all 0.3s;
    }
    .tab:hover { background: #f0f0f0; }
    .tab.active {
      background: #4CAF50;
      color: white;
    }
    
    .refresh-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .refresh-btn:hover { background: #1976D2; }
    
    .user-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .user-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #4CAF50;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      margin-right: 12px;
    }
    .user-name { font-size: 20px; font-weight: bold; }
    .status-row {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-dot.active { background: #4CAF50; animation: pulse 2s infinite; }
    .status-dot.idle { background: #9e9e9e; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .status-text { font-size: 16px; }
    .warning { color: #ff9800; font-size: 14px; margin-left: 8px; }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-top: 1px solid #eee;
    }
    .info-label { color: #666; }
    .info-value { font-weight: bold; }
    .points { color: #4CAF50; font-size: 24px; }
    .money { color: #ff9800; }
    .sync-time {
      font-size: 12px;
      color: #999;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .sync-time-row {
      display: flex;
      justify-content: space-between;
    }
    .sync-time-label { min-width: 70px; }
    .loading { text-align: center; padding: 40px; color: #666; }
    .error { color: #f44336; padding: 20px; text-align: center; }
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 12px 0;
    }
    .stat-item {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    .stat-value.points { color: #4CAF50; }
    .persons-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .persons-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .person-tag {
      display: inline-block;
      background: #e3f2fd;
      color: #1976D2;
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 13px;
      margin-right: 8px;
      margin-bottom: 4px;
    }
    .share-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    .share-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .share-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 6px;
    }
    .share-name {
      font-weight: 500;
      color: #333;
    }
    .share-detail {
      font-size: 13px;
      color: #4CAF50;
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .month-nav {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .month-nav-btn {
      background: #f0f0f0;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
    }
    .month-nav-btn:hover { background: #e0e0e0; }
    .month-title {
      font-size: 18px;
      font-weight: bold;
    }
    .month-summary {
      display: flex;
      gap: 20px;
      margin-bottom: 16px;
      padding: 12px;
      background: #e8f5e9;
      border-radius: 8px;
    }
    .month-summary-item {
      display: flex;
      flex-direction: column;
    }
    .month-summary-label {
      font-size: 12px;
      color: #666;
    }
    .month-summary-value {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
    }
    .month-summary-value.money { color: #ff9800; }
    
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    .history-table th,
    .history-table td {
      padding: 10px 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    .history-table th {
      background: #f5f5f5;
      font-weight: 500;
      color: #666;
      font-size: 13px;
    }
    .history-table td {
      font-size: 14px;
    }
    .history-table .date-col {
      text-align: left;
      font-weight: 500;
    }
    .history-table .points-col { color: #4CAF50; }
    .history-table .money-col { color: #ff9800; }
    .history-table tr.today {
      background: #fff8e1;
    }
    
    .user-select {
      margin-bottom: 16px;
    }
    .user-select select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
      width: 100%;
      max-width: 200px;
    }
    
    .hidden { display: none; }
    
    .settings-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .settings-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #333;
    }
    .settings-warning {
      background: #fff3e0;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      color: #e65100;
    }
    .clear-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }
    .clear-btn:hover { background: #d32f2f; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
    }
    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 16px;
    }
    .modal-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin-bottom: 16px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .modal-btn.cancel {
      background: #f5f5f5;
      color: #666;
    }
    .modal-btn.confirm {
      background: #f44336;
      color: white;
    }
    
    .admin-tab-btn {
      padding: 10px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #666;
    }
    .admin-tab-btn:hover { background: #f5f5f5; }
    .admin-tab-btn.active {
      background: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .admin-table th,
    .admin-table td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .admin-table th {
      background: #f5f5f5;
      font-weight: 500;
      color: #666;
      font-size: 13px;
    }
    .admin-table tr:hover {
      background: #fafafa;
    }
  </style>
</head>
<body>
  <h1 id="main-title" style="user-select: none;">è¿åŠ¨æŸ¥çœ‹ <span id="config-name" style="font-size: 14px; color: #999; margin-left: 8px;"></span></h1>
  
  <div class="tabs">
    <button class="tab active" onclick="switchTab('realtime')">å®æ—¶çŠ¶æ€</button>
    <button class="tab" onclick="switchTab('history')">å†å²è®°å½•</button>
    <button id="settings-tab" class="tab hidden" onclick="switchTab('settings')">è®¾ç½®</button>
    <button class="tab" onclick="switchTab('admin')">ç®¡ç†</button>
  </div>
  
  <button class="refresh-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
  
  <div id="realtime-content"></div>
  <div id="history-content" class="hidden"></div>
  <div id="settings-content" class="hidden"></div>
  <div id="admin-content" class="hidden"></div>
  
  <div id="password-modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">è¯·è¾“å…¥å¯†ç </div>
      <input type="password" id="password-input" class="modal-input" placeholder="è¯·è¾“å…¥å¯†ç ">
      <label style="display: flex; align-items: center; margin-bottom: 16px; font-size: 14px;">
        <input type="checkbox" id="keep-persons-checkbox" checked style="margin-right: 8px;">
        ä¿ç•™åˆ†è´¦äººå‘˜
      </label>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closePasswordModal()">å–æ¶ˆ</button>
        <button class="modal-btn confirm" onclick="confirmClearData()">ç¡®è®¤æ¸…é™¤</button>
      </div>
    </div>
  </div>
  
  <div id="unbind-modal" class="modal">
    <div class="modal-content">
      <div class="modal-title">è§£é™¤è®¾å¤‡ç»‘å®š</div>
      <p style="color: #666; margin-bottom: 12px;">è§£é™¤åï¼Œæ–°è®¾å¤‡å¯ä»¥é‡æ–°ç»‘å®šæ­¤ID</p>
      <input type="password" id="unbind-password-input" class="modal-input" placeholder="è¯·è¾“å…¥å¯†ç ">
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeUnbindModal()">å–æ¶ˆ</button>
        <button class="modal-btn confirm" onclick="confirmUnbind()">ç¡®è®¤è§£ç»‘</button>
      </div>
    </div>
  </div>

  <script>
    const CLOUD_CONFIG_ID = 2;  // 1=å®, 2=é•¿
    
    const CLOUD_CONFIGS = {
      1: {
        name: 'å®',
        url: 'https://vilitaarloxpgjbqgjmz.supabase.co',
        key: 'sb_publishable_-dlcp8B_dKge-fjN1wd2yQ_KUkhGreZ'
      },
      2: {
        name: 'é•¿',
        url: 'https://dvcvjyqydxqapghesxaw.supabase.co',
        key: 'sb_publishable_JzvR-nqE9y4KSkSXnRMMlg_MZt7I0Yx'
      }
    };
    
    const CLOUD_CONFIG = CLOUD_CONFIGS[CLOUD_CONFIG_ID];
    const SUPABASE_URL = CLOUD_CONFIG.url;
    const SUPABASE_ANON_KEY = CLOUD_CONFIG.key;
    const POINTS_TO_YUAN = 100;

    const activityNames = {
      'walk': 'æ•£æ­¥',
      'step': 'æ‘†æ‰‹è‡‚',
      'stand': 'ä¸¾æ‰‹æ”¾ä¸‹',
      'turn_head': 'è½¬å¤´',
      'raise_hand': 'ä¸¾æ‰‹',
      'clap': 'é¼“æŒ',
      'breath': 'æ·±å‘¼å¸',
      'say_good': 'è¯´å¥½'
    };

    let cachedData = null;
    let currentTab = 'realtime';
    let currentMonth = new Date().toISOString().substring(0, 7);
    let currentUserId = null;

    async function fetchAPI(table) {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    function parseUTCDate(dateStr) {
      if (!dateStr) return null;
      try {
        const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
        if (!match) return new Date(dateStr);
        return new Date(Date.UTC(
          parseInt(match[1], 10),
          parseInt(match[2], 10) - 1,
          parseInt(match[3], 10),
          parseInt(match[4], 10),
          parseInt(match[5], 10),
          parseInt(match[6], 10)
        ));
      } catch (e) { return null; }
    }

    function checkFreshness(updatedAt) {
      if (!updatedAt) return { fresh: true, text: 'åˆšåˆš' };
      const diffMin = Math.floor((new Date() - parseUTCDate(updatedAt)) / 60000);
      if (diffMin < 0) return { fresh: true, text: 'åˆšåˆš' };
      
      const days = Math.floor(diffMin / 1440);
      const hours = Math.floor((diffMin % 1440) / 60);
      const mins = diffMin % 60;
      
      let timeText = '';
      if (days > 0) {
        timeText = `${days}å¤©${hours}å°æ—¶${mins}åˆ†é’Ÿå‰`;
      } else if (hours > 0) {
        timeText = `${hours}å°æ—¶${mins}åˆ†é’Ÿå‰`;
      } else {
        timeText = `${mins}åˆ†é’Ÿå‰`;
      }
      
      if (diffMin > 3) return { fresh: false, text: `âš ï¸ ${timeText}` };
      return { fresh: true, text: timeText };
    }

    function formatTime(isoString) {
      if (!isoString) return '--';
      const d = parseUTCDate(isoString);
      if (!d) return isoString;
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
    }

    function pointsToMoney(points) {
      return (points / POINTS_TO_YUAN).toFixed(1);
    }

    function addDays(dateStr, days) {
      const d = new Date(dateStr);
      d.setDate(d.getDate() + days);
      return d.toISOString().split('T')[0];
    }

    async function loadData() {
      const [users, liveStatus, dailyRecords, allActivities] = await Promise.all([
        fetchAPI('users?select=*'),
        fetchAPI('live_status?select=*'),
        fetchAPI('daily_records?select=*'),
        fetchAPI('activities?select=*&order=date.desc,time.desc')
      ]);
      
      console.log('dailyRecords:', dailyRecords);
      console.log('allActivities:', allActivities);
      
      let persons = [];
      try { persons = await fetchAPI('persons?select=*'); } catch (e) {}
      
      cachedData = { users, liveStatus, dailyRecords, allActivities, persons };
      if (!currentUserId && users.length > 0) {
        currentUserId = users[0].id;
      }
      return cachedData;
    }

    async function refreshData() {
      const btn = document.querySelector('.refresh-btn');
      btn.textContent = 'ğŸ”„ åŠ è½½ä¸­...';
      btn.disabled = true;
      
      try {
        await loadData();
        if (currentTab === 'realtime') {
          renderRealtime();
        } else {
          renderHistory();
        }
      } catch (e) {
        alert('åŠ è½½å¤±è´¥: ' + e.message);
      }
      
      btn.textContent = 'ğŸ”„ åˆ·æ–°';
      btn.disabled = false;
    }

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('realtime-content').classList.add('hidden');
      document.getElementById('history-content').classList.add('hidden');
      document.getElementById('settings-content').classList.add('hidden');
      document.getElementById('admin-content').classList.add('hidden');
      
      if (tab === 'realtime') {
        document.getElementById('realtime-content').classList.remove('hidden');
        renderRealtime();
      } else if (tab === 'history') {
        document.getElementById('history-content').classList.remove('hidden');
        renderHistory();
      } else if (tab === 'settings') {
        document.getElementById('settings-content').classList.remove('hidden');
        renderSettings();
      } else if (tab === 'admin') {
        document.getElementById('admin-content').classList.remove('hidden');
        renderAdmin();
      }
    }

    function renderRealtime() {
      const content = document.getElementById('realtime-content');
      if (!cachedData) {
        content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        return;
      }
      
      const { users, liveStatus, dailyRecords, allActivities, persons } = cachedData;
      const today = new Date().toISOString().split('T')[0];
      const yesterday = addDays(today, -1);
      const monthStart = today.substring(0, 7) + '-01';

      let html = '';

      for (const user of users) {
        const status = liveStatus.find(s => s.user_id === user.id) || {};
        const userActivities = allActivities.filter(a => a.user_id === user.id);
        const userPersons = persons.filter(p => p.user_id === user.id);
        const todayRecord = dailyRecords.find(r => r.user_id === user.id && r.date === today);
        const yesterdayRecord = dailyRecords.find(r => r.user_id === user.id && r.date === yesterday);
        const monthRecords = dailyRecords.filter(r => r.user_id === user.id && r.date >= monthStart && r.date <= today);
        
        const todayPoints = todayRecord?.total_points || 0;
        const todayMorning = todayRecord?.morning_points || 0;
        const todayAfternoon = todayRecord?.afternoon_points || 0;
        const yesterdayPoints = yesterdayRecord?.total_points || 0;
        const monthPoints = monthRecords.reduce((sum, r) => sum + (r.total_points || 0), 0);
        
        const morningStart = user.morning_start || '06:00';
        const morningEnd = user.morning_end || '11:30';
        const afternoonStart = user.afternoon_start || '14:00';
        const afternoonEnd = user.afternoon_end || '18:00';
        
        const freshness = checkFreshness(status.updated_at);
        const isActive = status.status === 'active';
        const activityName = activityNames[status.current_activity] || status.current_activity;
        const elapsedMin = Math.floor((status.elapsed_seconds || 0) / 60);
        const startedAt = isActive 
          ? (status.activity_started_at ? formatTime(status.activity_started_at) : null)
          : (status.updated_at ? formatTime(status.updated_at) : null);
        
        const nowHour = new Date().getHours();
        const currentPeriod = nowHour < 12 ? 'ä¸Šåˆ' : 'ä¸‹åˆ';

        html += `
          <div class="user-card">
            <div class="user-header">
              <div class="avatar">${user.display_name?.charAt(0) || '?'}</div>
              <div class="user-name">${user.display_name || user.id}</div>
            </div>

            <div class="status-row">
              <span class="status-dot ${isActive ? 'active' : 'idle'}"></span>
              <span class="status-text">${isActive ? `æ­£åœ¨${activityName || 'è¿åŠ¨'}` : 'ä¼‘æ¯ä¸­'}</span>
              ${!freshness.fresh ? `<span class="warning">${freshness.text}</span>` : ''}
            </div>

            <div class="info-row">
              <span class="info-label">${isActive ? 'å¼€å§‹æ—¶é—´' : 'ä¼‘æ¯å¼€å§‹'}</span>
              <span class="info-value">${startedAt || '--'}</span>
            </div>
            ${isActive ? `
              <div class="info-row">
                <span class="info-label">å·²è¿›è¡Œ</span>
                <span class="info-value">${elapsedMin} åˆ†é’Ÿ</span>
              </div>
            ` : ''}

            <div class="stats-grid">
              <div class="stat-item">
                <div class="stat-label">ä»Šæ—¥ç§¯åˆ†</div>
                <div class="stat-value points">${todayPoints} åˆ†</div>
                <div class="stat-value money">${pointsToMoney(todayPoints)} å…ƒ</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">æ˜¨æ—¥ç§¯åˆ†</div>
                <div class="stat-value">${yesterdayPoints} åˆ†</div>
                <div class="stat-value money">${pointsToMoney(yesterdayPoints)} å…ƒ</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">å½“æœˆç§¯åˆ†</div>
                <div class="stat-value points">${monthPoints} åˆ†</div>
                <div class="stat-value money">${pointsToMoney(monthPoints)} å…ƒ</div>
              </div>
              <div class="stat-item">
                <div class="stat-label">å½“å‰æ—¶æ®µ</div>
                <div class="stat-value">${currentPeriod}</div>
              </div>
            </div>

            <div class="info-row">
              <span class="info-label">ä»Šæ—¥ä¸Šåˆ(${morningStart}-${morningEnd})</span>
              <span class="info-value">${todayMorning} åˆ† (${pointsToMoney(todayMorning)} å…ƒ)</span>
            </div>
            <div class="info-row">
              <span class="info-label">ä»Šæ—¥ä¸‹åˆ(${afternoonStart}-${afternoonEnd})</span>
              <span class="info-value">${todayAfternoon} åˆ† (${pointsToMoney(todayAfternoon)} å…ƒ)</span>
            </div>

            ${userPersons.length > 0 ? `
              <div class="persons-section">
                <div class="persons-title">åˆ†é…äººå‘˜ï¼š</div>
                <div>
                  ${userPersons.map(p => `<span class="person-tag">${p.person_name}</span>`).join('')}
                </div>
              </div>
              <div class="share-section">
                <div class="share-title">åˆ†è´¦æ˜ç»†ï¼š</div>
                ${userPersons.map(p => {
                  const eachTodayPoints = Math.floor(todayPoints / userPersons.length);
                  const eachMonthPoints = Math.floor(monthPoints / userPersons.length);
                  const eachTodayMoney = (eachTodayPoints / POINTS_TO_YUAN).toFixed(2);
                  const eachMonthMoney = (eachMonthPoints / POINTS_TO_YUAN).toFixed(2);
                  return `
                    <div class="share-item">
                      <span class="share-name">${p.person_name}</span>
                      <span class="share-detail">ä»Šæ—¥ ${eachTodayMoney} å…ƒ | æœ¬æœˆ ${eachMonthMoney} å…ƒ</span>
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}

            <div class="sync-time">
              <div class="sync-time-row">
                <span class="sync-time-label">Appæ—¶é—´ï¼š</span>
                <span>${status.app_time ? (new Date().toISOString().split('T')[0] + ' ' + status.app_time) : '--'}</span>
              </div>
              <div class="sync-time-row">
                <span class="sync-time-label">æœåŠ¡å™¨åŒæ­¥ï¼š</span>
                <span>${formatTime(status.updated_at)}</span>
              </div>
            </div>
          </div>
        `;
      }

      content.innerHTML = html;
    }

    function renderHistory() {
      const content = document.getElementById('history-content');
      if (!cachedData) {
        content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        return;
      }
      
      const { users, dailyRecords, allActivities } = cachedData;
      const today = new Date().toISOString().split('T')[0];
      
      let html = `
        <div class="user-card">
          <div class="user-select">
            <select onchange="currentUserId = this.value; renderHistory();">
              ${users.map(u => `<option value="${u.id}" ${u.id === currentUserId ? 'selected' : ''}>${u.display_name || u.id}</option>`).join('')}
            </select>
          </div>
          
          <div class="history-header">
            <div class="month-nav">
              <button class="month-nav-btn" onclick="changeMonth(-1)">â—€</button>
              <span class="month-title">${currentMonth.substring(0, 4)}å¹´${parseInt(currentMonth.substring(5))}æœˆ</span>
              <button class="month-nav-btn" onclick="changeMonth(1)">â–¶</button>
            </div>
          </div>
      `;
      
      const userActivities = allActivities.filter(a => a.user_id === currentUserId && a.date.startsWith(currentMonth));
      const userDailyRecords = dailyRecords.filter(r => r.user_id === currentUserId && r.date.startsWith(currentMonth));
      
      const dailyData = {};
      userDailyRecords.forEach(r => {
        dailyData[r.date] = {
          morning: r.morning_points || 0,
          afternoon: r.afternoon_points || 0
        };
      });
      
      const sortedDates = Object.keys(dailyData).sort((a, b) => b.localeCompare(a));
      
      let monthTotal = 0;
      sortedDates.forEach(d => {
        monthTotal += dailyData[d].morning + dailyData[d].afternoon;
      });
      
      html += `
          <div class="month-summary">
            <div class="month-summary-item">
              <span class="month-summary-label">æœ¬æœˆæ€»ç§¯åˆ†</span>
              <span class="month-summary-value">${monthTotal} åˆ†</span>
            </div>
            <div class="month-summary-item">
              <span class="month-summary-label">æœ¬æœˆæ€»é‡‘é¢</span>
              <span class="month-summary-value money">${pointsToMoney(monthTotal)} å…ƒ</span>
            </div>
          </div>
          
          <table class="history-table">
            <thead>
              <tr>
                <th>æ—¥æœŸ</th>
                <th>ä¸Šåˆ</th>
                <th>ä¸‹åˆ</th>
                <th>åˆè®¡</th>
                <th>é‡‘é¢</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      if (sortedDates.length === 0) {
        html += '<tr><td colspan="5" style="color:#999;padding:20px;">æš‚æ— æ•°æ®</td></tr>';
      } else {
        sortedDates.forEach(date => {
          const d = dailyData[date];
          const total = d.morning + d.afternoon;
          const isToday = date === today;
          
          html += `
            <tr class="${isToday ? 'today' : ''}">
              <td class="date-col">${date.substring(5)}${isToday ? ' (ä»Šæ—¥)' : ''}</td>
              <td class="points-col">${d.morning}</td>
              <td class="points-col">${d.afternoon}</td>
              <td class="points-col">${total}</td>
              <td class="money-col">${pointsToMoney(total)}</td>
            </tr>
          `;
        });
      }
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      content.innerHTML = html;
    }

    function changeMonth(delta) {
      const [year, month] = currentMonth.split('-').map(Number);
      let newMonth = month + delta;
      let newYear = year;
      
      if (newMonth > 12) {
        newMonth = 1;
        newYear++;
      } else if (newMonth < 1) {
        newMonth = 12;
        newYear--;
      }
      
      currentMonth = `${newYear}-${String(newMonth).padStart(2, '0')}`;
      renderHistory();
    }

    function renderSettings() {
      const content = document.getElementById('settings-content');
      if (!cachedData) {
        content.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        return;
      }
      
      const { users } = cachedData;
      
      let html = `
        <div class="settings-section">
          <div class="settings-title">ç”¨æˆ·è®¾ç½®</div>
          <div class="user-select">
            <label>é€‰æ‹©ç”¨æˆ·ï¼š</label>
            <select id="user-select" onchange="loadUserSettings()">
              ${users.map(u => `<option value="${u.id}">${u.display_name || u.id}</option>`).join('')}
            </select>
          </div>
          <div style="margin: 10px 0;">
            <label>æ˜¾ç¤ºåç§°ï¼š</label>
            <input type="text" id="display-name-input" style="padding: 8px; width: 150px;">
            <button onclick="saveDisplayName()" style="padding: 8px 16px; margin-left: 8px;">ä¿å­˜</button>
          </div>
        </div>
        
        <div class="settings-section" style="margin-top: 20px;">
          <div class="settings-title">æ—¶æ®µé…ç½®</div>
          <div style="margin: 10px 0;">
            <label>ä¸Šåˆæ—¶æ®µï¼š</label>
            <input type="time" id="morning-start-input" value="06:00" style="padding: 6px;"> - 
            <input type="time" id="morning-end-input" value="11:30" style="padding: 6px;">
          </div>
          <div style="margin: 10px 0;">
            <label>ä¸‹åˆæ—¶æ®µï¼š</label>
            <input type="time" id="afternoon-start-input" value="14:00" style="padding: 6px;"> - 
            <input type="time" id="afternoon-end-input" value="18:00" style="padding: 6px;">
          </div>
          <div style="margin: 10px 0;">
            <label><input type="checkbox" id="debug-mode-input"> è°ƒè¯•æ¨¡å¼ï¼ˆå…¨æ—¶æ®µå¯ç”¨ï¼‰</label>
          </div>
          <div style="margin: 10px 0;">
            <label><input type="checkbox" id="say-good-input"> å¯ç”¨è¯´"å¥½"ä»»åŠ¡</label>
          </div>
          <button onclick="saveConfig()" style="padding: 8px 16px;">ä¿å­˜é…ç½®</button>
        </div>
        
        <div class="settings-section" style="margin-top: 20px;">
          <div class="settings-title">ç»‘å®šäººå‘˜</div>
          <div class="settings-warning" style="font-size: 12px;">
            è®¾ç½®åè¯·åœ¨Appç«¯ç‚¹å‡»"åŒæ­¥äººå‘˜"ä»¥æ›´æ–°æœ¬åœ°æ•°æ®
          </div>
          <div style="margin: 10px 0;">
            <label>äººå‘˜1ï¼š</label>
            <input type="text" id="person1-input" style="padding: 8px; width: 120px;" placeholder="å§“å">
          </div>
          <div style="margin: 10px 0;">
            <label>äººå‘˜2ï¼š</label>
            <input type="text" id="person2-input" style="padding: 8px; width: 120px;" placeholder="å§“å">
          </div>
          <div style="margin: 10px 0;">
            <label>äººå‘˜3ï¼š</label>
            <input type="text" id="person3-input" style="padding: 8px; width: 120px;" placeholder="å§“å">
          </div>
          <button onclick="savePersons()" style="padding: 8px 16px;">ä¿å­˜äººå‘˜</button>
        </div>
        
        <div class="settings-section" style="margin-top: 20px;">
          <div class="settings-title">è®¾å¤‡ç»‘å®šç®¡ç†</div>
          <div id="bind-status" style="margin: 10px 0; color: #666;">åŠ è½½ä¸­...</div>
          <button class="clear-btn" style="background: #FF9800;" onclick="showUnbindModal()">ğŸ”“ è§£é™¤è®¾å¤‡ç»‘å®š</button>
        </div>
        
        <div class="settings-section" style="margin-top: 20px;">
          <div class="settings-title">æ¸…é™¤æ‰€æœ‰æ•°æ®</div>
          <div class="settings-warning">
            âš ï¸ æ­¤æ“ä½œå°†æ¸…ç©ºäº‘ç«¯è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®ï¼ˆæ¯æ—¥è®°å½•ã€æ´»åŠ¨æ˜ç»†ï¼‰<br>
            æ¸…é™¤åè¯·åœ¨Appç«¯ç‚¹å‡»"ä»äº‘ç«¯åŒæ­¥"ä»¥æ¸…ç©ºæœ¬åœ°æ•°æ®
          </div>
          <button class="clear-btn" onclick="showPasswordModal()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
        </div>
      `;
      
      content.innerHTML = html;
      loadUserSettings();
    }
    
    async function loadUserSettings() {
      const userId = document.getElementById('user-select').value;
      
      // åŠ è½½ç”¨æˆ·æ˜¾ç¤ºåç§°
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}&select=display_name,device_token,bound_at,morning_start,morning_end,afternoon_start,afternoon_end,debug_mode,say_good_enabled`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        
        const data = await res.json();
        if (data && data.length > 0) {
          const user = data[0];
          document.getElementById('display-name-input').value = user.display_name || '';
          
          document.getElementById('morning-start-input').value = user.morning_start || '06:00';
          document.getElementById('morning-end-input').value = user.morning_end || '11:30';
          document.getElementById('afternoon-start-input').value = user.afternoon_start || '14:00';
          document.getElementById('afternoon-end-input').value = user.afternoon_end || '18:00';
          document.getElementById('debug-mode-input').checked = user.debug_mode || false;
          document.getElementById('say-good-input').checked = user.say_good_enabled !== false;
          
          if (user.device_token) {
            const boundTime = user.bound_at ? new Date(user.bound_at).toLocaleString('zh-CN') : 'æœªçŸ¥';
            document.getElementById('bind-status').innerHTML = `<span style="color: #4CAF50;">âœ“ å·²ç»‘å®š</span>ï¼ˆç»‘å®šæ—¶é—´ï¼š${boundTime}ï¼‰`;
          } else {
            document.getElementById('bind-status').innerHTML = `<span style="color: #FF9800;">â—‹ æœªç»‘å®š</span>`;
          }
        }
      } catch (e) {
        console.error('loadUserSettings error:', e);
      }
      
      // åŠ è½½ç»‘å®šäººå‘˜
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/persons?user_id=eq.${userId}&select=person_index,person_name&order=person_index`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        
        const persons = await res.json();
        document.getElementById('person1-input').value = '';
        document.getElementById('person2-input').value = '';
        document.getElementById('person3-input').value = '';
        
        if (persons && persons.length > 0) {
          persons.forEach(p => {
            const input = document.getElementById(`person${p.person_index + 1}-input`);
            if (input) input.value = p.person_name || '';
          });
        }
      } catch (e) {
        console.error('loadPersons error:', e);
      }
    }
    
    async function saveDisplayName() {
      const userId = document.getElementById('user-select').value;
      const displayName = document.getElementById('display-name-input').value.trim();
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ display_name: displayName })
        });
        
        if (res.ok) {
          alert('ä¿å­˜æˆåŠŸï¼');
          refreshData();
        } else {
          alert('ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    async function saveConfig() {
      const userId = document.getElementById('user-select').value;
      const morningStart = document.getElementById('morning-start-input').value;
      const morningEnd = document.getElementById('morning-end-input').value;
      const afternoonStart = document.getElementById('afternoon-start-input').value;
      const afternoonEnd = document.getElementById('afternoon-end-input').value;
      const debugMode = document.getElementById('debug-mode-input').checked;
      const sayGoodEnabled = document.getElementById('say-good-input').checked;
      
      function timeToMinutes(t) {
        const [h, m] = t.split(':').map(Number);
        return h * 60 + m;
      }
      
      if (timeToMinutes(morningEnd) <= timeToMinutes(morningStart)) {
        alert('ä¸Šåˆç»“æŸæ—¶é—´å¿…é¡»å¤§äºå¼€å§‹æ—¶é—´');
        return;
      }
      if (timeToMinutes(afternoonEnd) <= timeToMinutes(afternoonStart)) {
        alert('ä¸‹åˆç»“æŸæ—¶é—´å¿…é¡»å¤§äºå¼€å§‹æ—¶é—´');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            morning_start: morningStart,
            morning_end: morningEnd,
            afternoon_start: afternoonStart,
            afternoon_end: afternoonEnd,
            debug_mode: debugMode,
            say_good_enabled: sayGoodEnabled
          })
        });
        
        if (res.ok) {
          alert('é…ç½®ä¿å­˜æˆåŠŸï¼Appç«¯ä¸‹æ¬¡å¯åŠ¨æ—¶å°†è‡ªåŠ¨åŒæ­¥ã€‚');
          await loadData();
          loadUserSettings();
        } else {
          alert('ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    async function savePersons() {
      const userId = document.getElementById('user-select').value;
      const persons = [
        { index: 0, name: document.getElementById('person1-input').value.trim() },
        { index: 1, name: document.getElementById('person2-input').value.trim() },
        { index: 2, name: document.getElementById('person3-input').value.trim() }
      ];
      
      try {
        // å…ˆåˆ é™¤æ—§æ•°æ®
        await fetch(`${SUPABASE_URL}/rest/v1/persons?user_id=eq.${userId}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Prefer': 'return=minimal'
          }
        });
        
        // æ’å…¥æ–°æ•°æ®
        for (const p of persons) {
          if (p.name) {
            await fetch(`${SUPABASE_URL}/rest/v1/persons`, {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
              },
              body: JSON.stringify({
                user_id: userId,
                person_index: p.index,
                person_name: p.name
              })
            });
          }
        }
        
        alert('ä¿å­˜æˆåŠŸï¼è¯·åœ¨Appç«¯ç‚¹å‡»"åŒæ­¥äººå‘˜"ä»¥æ›´æ–°æœ¬åœ°æ•°æ®ã€‚');
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    function showUnbindModal() {
      document.getElementById('unbind-modal').classList.add('show');
      document.getElementById('unbind-password-input').value = '';
    }

    function closeUnbindModal() {
      document.getElementById('unbind-modal').classList.remove('show');
    }

    async function confirmUnbind() {
      const password = document.getElementById('unbind-password-input').value;
      const userId = document.getElementById('user-select').value;
      
      if (!password) {
        alert('è¯·è¾“å…¥å¯†ç ');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/unbind_device`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            p_user_id: userId,
            p_password: password
          })
        });
        
        const result = await res.json();
        
        if (result.success) {
          alert('è§£ç»‘æˆåŠŸï¼æ–°è®¾å¤‡å¯ä»¥é‡æ–°ç»‘å®šæ­¤IDã€‚');
          closeUnbindModal();
          updateBindStatus();
        } else {
          alert(result.message || 'è§£ç»‘å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }

    function showPasswordModal() {
      document.getElementById('password-modal').classList.add('show');
      document.getElementById('password-input').value = '';
    }

    function closePasswordModal() {
      document.getElementById('password-modal').classList.remove('show');
    }

    async function confirmClearData() {
      const password = document.getElementById('password-input').value;
      const userId = document.getElementById('user-select').value;
      const keepPersons = document.getElementById('keep-persons-checkbox').checked;
      
      if (!password) {
        alert('è¯·è¾“å…¥å¯†ç ');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/rpc/clear_all_data`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            p_user_id: userId,
            p_password: password,
            p_keep_persons: keepPersons
          })
        });
        
        const result = await res.json();
        
        if (result.success) {
          alert('æ¸…é™¤æˆåŠŸï¼è¯·åœ¨Appç«¯ç‚¹å‡»"ä»äº‘ç«¯åŒæ­¥"ä»¥æ¸…ç©ºæœ¬åœ°æ•°æ®ã€‚');
          closePasswordModal();
          refreshData();
        } else {
          alert(result.message || 'æ¸…é™¤å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }

    // éšè—è®¾ç½®åŠŸèƒ½ï¼šè¿ç»­ç‚¹å‡»æ ‡é¢˜5æ¬¡æ˜¾ç¤º/éšè—è®¾ç½®æ ‡ç­¾
    let titleClickCount = 0;
    let titleClickTimer = null;
    let settingsVisible = false;
    
    document.getElementById('main-title').addEventListener('click', function() {
      titleClickCount++;
      
      if (titleClickTimer) {
        clearTimeout(titleClickTimer);
      }
      
      titleClickTimer = setTimeout(function() {
        titleClickCount = 0;
      }, 2000);
      
      if (titleClickCount >= 5) {
        settingsVisible = !settingsVisible;
        const settingsTab = document.getElementById('settings-tab');
        if (settingsVisible) {
          settingsTab.classList.remove('hidden');
        } else {
          settingsTab.classList.add('hidden');
          if (document.getElementById('settings-content').classList.contains('hidden') === false) {
            switchTab('realtime');
          }
        }
        titleClickCount = 0;
      }
    });

    // ========== ç®¡ç†é¡µé¢ ==========
    let cachedTemplates = [];
    let cachedGlobalPrompts = [];
    let adminTab = 'users';
    
    async function renderAdmin() {
      const content = document.getElementById('admin-content');
      
      content.innerHTML = `
        <div class="admin-tabs" style="display: flex; gap: 8px; margin-bottom: 16px;">
          <button class="admin-tab-btn ${adminTab === 'users' ? 'active' : ''}" onclick="switchAdminTab('users')">ç”¨æˆ·ç®¡ç†</button>
          <button class="admin-tab-btn ${adminTab === 'templates' ? 'active' : ''}" onclick="switchAdminTab('templates')">ä»»åŠ¡æ¨¡æ¿</button>
          <button class="admin-tab-btn ${adminTab === 'prompts' ? 'active' : ''}" onclick="switchAdminTab('prompts')">æç¤ºè¯­</button>
        </div>
        <div id="admin-panel"></div>
      `;
      
      if (adminTab === 'users') {
        renderAdminUsers();
      } else if (adminTab === 'templates') {
        renderAdminTemplates();
      } else if (adminTab === 'prompts') {
        renderAdminPrompts();
      }
    }
    
    function switchAdminTab(tab) {
      adminTab = tab;
      document.querySelectorAll('.admin-tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      renderAdmin();
    }
    
    // ç”¨æˆ·ç®¡ç†
    async function renderAdminUsers() {
      const panel = document.getElementById('admin-panel');
      panel.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      if (!cachedData) {
        await loadData();
      }
      
      const { users, persons } = cachedData;
      
      let html = `
        <div class="settings-section">
          <div class="settings-title">ç”¨æˆ·åˆ—è¡¨ <button onclick="showAddUserModal()" style="float: right; padding: 6px 12px; font-size: 14px;">+ æ–°å¢ç”¨æˆ·</button></div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>è®¾å¤‡ç¼–å·</th>
                <th>æ˜¾ç¤ºåç§°</th>
                <th>æ—¶æ®µé…ç½®</th>
                <th>ä»»åŠ¡é¡ºåº</th>
                <th>ç»‘å®šçŠ¶æ€</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(u => {
                const userPersons = persons.filter(p => p.user_id === u.id);
                return `
                  <tr>
                    <td>${u.id}</td>
                    <td>${u.display_name || '-'}</td>
                    <td style="font-size: 12px;">
                      ä¸Šåˆ: ${u.morning_start || '06:00'}-${u.morning_end || '11:30'}<br>
                      ä¸‹åˆ: ${u.afternoon_start || '14:00'}-${u.afternoon_end || '18:00'}
                    </td>
                    <td style="font-size: 12px;">${(u.task_order || 'walk,step,stand,turn_head,raise_hand,clap,breath,say_good').split(',').slice(0, 3).join(',')}...</td>
                    <td>${u.device_token ? '<span style="color: #4CAF50;">å·²ç»‘å®š</span>' : '<span style="color: #FF9800;">æœªç»‘å®š</span>'}</td>
                    <td>
                      <button onclick="showEditUserModal('${u.id}')" style="padding: 4px 8px; font-size: 12px;">ç¼–è¾‘</button>
                      <button onclick="showUserPersonsModal('${u.id}')" style="padding: 4px 8px; font-size: 12px;">äººå‘˜(${userPersons.length})</button>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      panel.innerHTML = html;
    }
    
    // ä»»åŠ¡æ¨¡æ¿ç®¡ç†
    async function renderAdminTemplates() {
      const panel = document.getElementById('admin-panel');
      panel.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/task_templates?order=task_type`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        cachedTemplates = await res.json();
      } catch (e) {
        console.error('load templates error:', e);
        cachedTemplates = [];
      }
      
      const taskNames = {
        'walk': 'æ•£æ­¥', 'step': 'æ‘†æ‰‹è‡‚', 'stand': 'ä¸¾æ‰‹æ”¾ä¸‹',
        'turn_head': 'è½¬å¤´', 'raise_hand': 'ä¸¾æ‰‹', 'clap': 'é¼“æŒ',
        'breath': 'æ·±å‘¼å¸', 'say_good': 'è¯´"å¥½"'
      };
      
      let html = `
        <div class="settings-section">
          <div class="settings-title">ä»»åŠ¡æ¨¡æ¿é…ç½®</div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>ä»»åŠ¡ç±»å‹</th>
                <th>åç§°</th>
                <th>æ—¶é•¿(åˆ†)</th>
                <th>æ¬¡æ•°</th>
                <th>ç§¯åˆ†</th>
                <th>é€Ÿåº¦é˜ˆå€¼</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${cachedTemplates.map(t => `
                <tr>
                  <td>${t.task_type}</td>
                  <td>${t.task_name || taskNames[t.task_type] || '-'}</td>
                  <td>${t.duration || 0}</td>
                  <td>${t.count || 0}</td>
                  <td>${t.points || 0}</td>
                  <td>${t.max_speed || 0}</td>
                  <td><button onclick="showEditTemplateModal('${t.task_type}')" style="padding: 4px 8px; font-size: 12px;">ç¼–è¾‘</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      panel.innerHTML = html;
    }
    
    // æç¤ºè¯­ç®¡ç†
    async function renderAdminPrompts() {
      const panel = document.getElementById('admin-panel');
      panel.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/global_prompts?order=key`, {
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          }
        });
        cachedGlobalPrompts = await res.json();
      } catch (e) {
        console.error('load prompts error:', e);
        cachedGlobalPrompts = [];
      }
      
      let html = `
        <div class="settings-section">
          <div class="settings-title">å…¨å±€æç¤ºè¯­</div>
          <table class="admin-table">
            <thead>
              <tr>
                <th>é”®</th>
                <th>å†…å®¹</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              ${cachedGlobalPrompts.map(p => `
                <tr>
                  <td>${p.key}</td>
                  <td style="font-size: 13px; max-width: 400px; overflow: hidden; text-overflow: ellipsis;">${p.value}</td>
                  <td><button onclick="showEditPromptModal('${p.key}')" style="padding: 4px 8px; font-size: 12px;">ç¼–è¾‘</button></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      panel.innerHTML = html;
    }
    
    // ========== å¼¹çª— ==========
    
    // æ–°å¢ç”¨æˆ·å¼¹çª—
    function showAddUserModal() {
      const html = `
        <div class="modal show" id="add-user-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-title">æ–°å¢ç”¨æˆ·</div>
            <div style="margin-bottom: 12px;">
              <label>è®¾å¤‡ç¼–å·ï¼š</label>
              <input type="text" id="new-user-id" style="width: 100px; padding: 8px;" placeholder="å¦‚ 001">
            </div>
            <div style="margin-bottom: 12px;">
              <label>æ˜¾ç¤ºåç§°ï¼š</label>
              <input type="text" id="new-user-name" style="width: 150px; padding: 8px;" placeholder="å§“å">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸Šåˆæ—¶æ®µï¼š</label>
              <input type="time" id="new-morning-start" value="06:00" style="padding: 6px;"> - 
              <input type="time" id="new-morning-end" value="11:30" style="padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸‹åˆæ—¶æ®µï¼š</label>
              <input type="time" id="new-afternoon-start" value="14:00" style="padding: 6px;"> - 
              <input type="time" id="new-afternoon-end" value="18:00" style="padding: 6px;">
            </div>
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('add-user-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="createUser()">åˆ›å»º</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    async function createUser() {
      const id = document.getElementById('new-user-id').value.trim();
      const displayName = document.getElementById('new-user-name').value.trim();
      const morningStart = document.getElementById('new-morning-start').value;
      const morningEnd = document.getElementById('new-morning-end').value;
      const afternoonStart = document.getElementById('new-afternoon-start').value;
      const afternoonEnd = document.getElementById('new-afternoon-end').value;
      
      if (!id) {
        alert('è¯·è¾“å…¥è®¾å¤‡ç¼–å·');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            id: id,
            display_name: displayName,
            morning_start: morningStart,
            morning_end: morningEnd,
            afternoon_start: afternoonStart,
            afternoon_end: afternoonEnd,
            task_order: 'walk,step,stand,turn_head,raise_hand,clap,breath,say_good',
            morning_max_points: 1500,
            afternoon_max_points: 1500,
            show_money: true,
            points_to_yuan: 100,
            say_good_enabled: true,
            debug_mode: false
          })
        });
        
        if (res.ok) {
          alert('åˆ›å»ºæˆåŠŸï¼');
          document.getElementById('add-user-modal').remove();
          await loadData();
          renderAdminUsers();
        } else {
          const err = await res.text();
          alert('åˆ›å»ºå¤±è´¥ï¼š' + err);
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // ç¼–è¾‘ç”¨æˆ·å¼¹çª—
    async function showEditUserModal(userId) {
      const user = cachedData.users.find(u => u.id === userId);
      if (!user) return;
      
      const taskTypes = ['walk', 'step', 'stand', 'turn_head', 'raise_hand', 'clap', 'breath', 'say_good'];
      const taskNames = {
        'walk': 'æ•£æ­¥', 'step': 'æ‘†æ‰‹è‡‚', 'stand': 'ä¸¾æ‰‹æ”¾ä¸‹',
        'turn_head': 'è½¬å¤´', 'raise_hand': 'ä¸¾æ‰‹', 'clap': 'é¼“æŒ',
        'breath': 'æ·±å‘¼å¸', 'say_good': 'è¯´"å¥½"'
      };
      const currentOrder = (user.task_order || taskTypes.join(',')).split(',');
      
      const html = `
        <div class="modal show" id="edit-user-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-title">ç¼–è¾‘ç”¨æˆ· - ${userId}</div>
            <div style="margin-bottom: 12px;">
              <label>æ˜¾ç¤ºåç§°ï¼š</label>
              <input type="text" id="edit-display-name" value="${user.display_name || ''}" style="width: 150px; padding: 8px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸Šåˆæ—¶æ®µï¼š</label>
              <input type="time" id="edit-morning-start" value="${user.morning_start || '06:00'}" style="padding: 6px;"> - 
              <input type="time" id="edit-morning-end" value="${user.morning_end || '11:30'}" style="padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸‹åˆæ—¶æ®µï¼š</label>
              <input type="time" id="edit-afternoon-start" value="${user.afternoon_start || '14:00'}" style="padding: 6px;"> - 
              <input type="time" id="edit-afternoon-end" value="${user.afternoon_end || '18:00'}" style="padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸Šåˆæœ€å¤§ç§¯åˆ†ï¼š</label>
              <input type="number" id="edit-morning-max" value="${user.morning_max_points || 1500}" style="width: 80px; padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä¸‹åˆæœ€å¤§ç§¯åˆ†ï¼š</label>
              <input type="number" id="edit-afternoon-max" value="${user.afternoon_max_points || 1500}" style="width: 80px; padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>ç§¯åˆ†å…‘æ¢æ¯”ä¾‹ï¼š</label>
              <input type="number" id="edit-points-to-yuan" value="${user.points_to_yuan || 100}" style="width: 80px; padding: 6px;"> ç§¯åˆ† = 1å…ƒ
            </div>
            <div style="margin-bottom: 12px;">
              <label><input type="checkbox" id="edit-show-money" ${user.show_money !== false ? 'checked' : ''}> æ˜¾ç¤ºé‡‘é¢</label>
              <label style="margin-left: 16px;"><input type="checkbox" id="edit-debug-mode" ${user.debug_mode ? 'checked' : ''}> è°ƒè¯•æ¨¡å¼</label>
              <label style="margin-left: 16px;"><input type="checkbox" id="edit-say-good" ${user.say_good_enabled !== false ? 'checked' : ''}> å¯ç”¨è¯´"å¥½"</label>
            </div>
            <div style="margin-bottom: 12px;">
              <label>ä»»åŠ¡é¡ºåºï¼ˆå‹¾é€‰å¯ç”¨çš„ä»»åŠ¡ï¼‰ï¼š</label>
              <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                ${taskTypes.map(t => `
                  <label style="display: flex; align-items: center; padding: 4px 8px; background: #f0f0f0; border-radius: 4px;">
                    <input type="checkbox" class="task-checkbox" value="${t}" ${currentOrder.includes(t) ? 'checked' : ''} onchange="updateTaskOrder()">
                    ${taskNames[t]}
                  </label>
                `).join('')}
              </div>
              <input type="hidden" id="edit-task-order" value="${currentOrder.join(',')}">
            </div>
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('edit-user-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="saveUser('${userId}')">ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function updateTaskOrder() {
      const checkboxes = document.querySelectorAll('.task-checkbox:checked');
      const order = Array.from(checkboxes).map(cb => cb.value);
      document.getElementById('edit-task-order').value = order.join(',');
    }
    
    async function saveUser(userId) {
      const displayName = document.getElementById('edit-display-name').value.trim();
      const morningStart = document.getElementById('edit-morning-start').value;
      const morningEnd = document.getElementById('edit-morning-end').value;
      const afternoonStart = document.getElementById('edit-afternoon-start').value;
      const afternoonEnd = document.getElementById('edit-afternoon-end').value;
      const morningMax = parseInt(document.getElementById('edit-morning-max').value) || 1500;
      const afternoonMax = parseInt(document.getElementById('edit-afternoon-max').value) || 1500;
      const pointsToYuan = parseInt(document.getElementById('edit-points-to-yuan').value) || 100;
      const showMoney = document.getElementById('edit-show-money').checked;
      const debugMode = document.getElementById('edit-debug-mode').checked;
      const sayGoodEnabled = document.getElementById('edit-say-good').checked;
      const taskOrder = document.getElementById('edit-task-order').value;
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/users?id=eq.${userId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({
            display_name: displayName,
            morning_start: morningStart,
            morning_end: morningEnd,
            afternoon_start: afternoonStart,
            afternoon_end: afternoonEnd,
            morning_max_points: morningMax,
            afternoon_max_points: afternoonMax,
            points_to_yuan: pointsToYuan,
            show_money: showMoney,
            debug_mode: debugMode,
            say_good_enabled: sayGoodEnabled,
            task_order: taskOrder
          })
        });
        
        if (res.ok) {
          alert('ä¿å­˜æˆåŠŸï¼');
          document.getElementById('edit-user-modal').remove();
          await loadData();
          renderAdminUsers();
        } else {
          alert('ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // äººå‘˜ç®¡ç†å¼¹çª—
    async function showUserPersonsModal(userId) {
      const userPersons = cachedData.persons.filter(p => p.user_id === userId);
      
      const html = `
        <div class="modal show" id="persons-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
            <div class="modal-title">åˆ†è´¦äººå‘˜ - ${userId}</div>
            <div id="persons-list">
              ${[0, 1, 2].map(i => {
                const p = userPersons.find(up => up.person_index === i);
                return `
                  <div style="margin-bottom: 8px;">
                    <label>äººå‘˜${i + 1}ï¼š</label>
                    <input type="text" class="person-input" data-index="${i}" value="${p ? p.person_name : ''}" style="width: 150px; padding: 8px;" placeholder="å§“å">
                  </div>
                `;
              }).join('')}
            </div>
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('persons-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="saveUserPersons('${userId}')">ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    async function saveUserPersons(userId) {
      const inputs = document.querySelectorAll('.person-input');
      const persons = [];
      
      inputs.forEach(input => {
        const name = input.value.trim();
        if (name) {
          persons.push({
            user_id: userId,
            person_index: parseInt(input.dataset.index),
            person_name: name
          });
        }
      });
      
      try {
        // å…ˆåˆ é™¤æ—§æ•°æ®
        await fetch(`${SUPABASE_URL}/rest/v1/persons?user_id=eq.${userId}`, {
          method: 'DELETE',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Prefer': 'return=minimal'
          }
        });
        
        // æ’å…¥æ–°æ•°æ®
        for (const p of persons) {
          await fetch(`${SUPABASE_URL}/rest/v1/persons`, {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=minimal'
            },
            body: JSON.stringify(p)
          });
        }
        
        alert('ä¿å­˜æˆåŠŸï¼');
        document.getElementById('persons-modal').remove();
        await loadData();
        renderAdminUsers();
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // ç¼–è¾‘ä»»åŠ¡æ¨¡æ¿å¼¹çª—
    function showEditTemplateModal(taskType) {
      const template = cachedTemplates.find(t => t.task_type === taskType);
      if (!template) return;
      
      const promptConfig = template.prompt_config || {};
      const taskIntro = promptConfig.task_intro || '';
      const tooFast = promptConfig.too_fast || 'å¤ªå¿«äº†ï¼Œè¯·æ…¢ä¸€ç‚¹';
      const paused = promptConfig.paused || 'è¯·ç»§ç»­';
      const inProgress = promptConfig.in_progress || '';
      const completed = promptConfig.completed || 'å¤ªå¥½äº†ï¼Œè·å¾—{points}ç§¯åˆ†';
      const progress = promptConfig.progress || '';
      
      const html = `
        <div class="modal show" id="template-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 550px; max-height: 85vh; overflow-y: auto;" onclick="event.stopPropagation()">
            <div class="modal-title">ç¼–è¾‘ä»»åŠ¡æ¨¡æ¿ - ${taskType}</div>
            <div style="margin-bottom: 12px;">
              <label>ä»»åŠ¡åç§°ï¼š</label>
              <input type="text" id="template-name" value="${template.task_name || ''}" style="width: 150px; padding: 8px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
              <input type="number" id="template-duration" value="${template.duration || 0}" style="width: 80px; padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>æ¬¡æ•°ï¼ˆè¯´"å¥½"ä¸“ç”¨ï¼‰ï¼š</label>
              <input type="number" id="template-count" value="${template.count || 0}" style="width: 80px; padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>å›ºå®šç§¯åˆ†ï¼š</label>
              <input type="number" id="template-points" value="${template.points || 0}" style="width: 80px; padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>æœ€å¤§é€Ÿåº¦é˜ˆå€¼ï¼š</label>
              <input type="number" id="template-max-speed" value="${template.max_speed || 0}" style="width: 80px; padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>æœ€å°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ï¼š</label>
              <input type="number" id="template-min-interval" value="${template.min_interval || 0}" style="width: 100px; padding: 6px;">
            </div>
            <div style="margin-bottom: 12px;">
              <label>æš‚åœé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰ï¼š</label>
              <input type="number" id="template-pause-threshold" value="${template.pause_threshold || 0}" style="width: 100px; padding: 6px;">
            </div>
            
            <div style="border-top: 1px solid #eee; margin: 16px 0; padding-top: 12px;">
              <div style="font-weight: 500; margin-bottom: 10px; cursor: pointer;" onclick="togglePromptConfig()">
                ğŸ“¢ æç¤ºè¯­é…ç½® <span id="prompt-toggle-icon" style="font-size: 12px;">â–¼</span>
              </div>
              <div id="prompt-config-area">
                <div style="margin-bottom: 10px;">
                  <label style="font-size: 13px; color: #666;">ä»»åŠ¡è¯´æ˜ <span style="color: #999;">({duration}=æ—¶é•¿, {count}=æ¬¡æ•°)</span>ï¼š</label><br>
                  <textarea id="prompt-intro" style="width: 100%; height: 50px; padding: 6px; font-size: 13px;">${taskIntro}</textarea>
                </div>
                <div style="margin-bottom: 10px;">
                  <label style="font-size: 13px; color: #666;">å¤ªå¿«æç¤ºï¼š</label><br>
                  <input type="text" id="prompt-too-fast" value="${tooFast}" style="width: 100%; padding: 6px; font-size: 13px;">
                </div>
                <div style="margin-bottom: 10px;">
                  <label style="font-size: 13px; color: #666;">æš‚åœæç¤ºï¼š</label><br>
                  <input type="text" id="prompt-paused" value="${paused}" style="width: 100%; padding: 6px; font-size: 13px;">
                </div>
                <div style="margin-bottom: 10px;">
                  <label style="font-size: 13px; color: #666;">è¿›è¡Œä¸­æç¤ºï¼š</label><br>
                  <input type="text" id="prompt-in-progress" value="${inProgress}" style="width: 100%; padding: 6px; font-size: 13px;">
                </div>
                <div style="margin-bottom: 10px;">
                  <label style="font-size: 13px; color: #666;">å®Œæˆæç¤º <span style="color: #999;">({points}=ç§¯åˆ†)</span>ï¼š</label><br>
                  <input type="text" id="prompt-completed" value="${completed}" style="width: 100%; padding: 6px; font-size: 13px;">
                </div>
                <div style="margin-bottom: 10px;">
                  <label style="font-size: 13px; color: #666;">è¿›åº¦æç¤º <span style="color: #999;">({current}=å·²è¿›è¡Œ, {remaining}=å‰©ä½™)</span>ï¼š</label><br>
                  <input type="text" id="prompt-progress" value="${progress}" style="width: 100%; padding: 6px; font-size: 13px;" placeholder="ä»…æ•£æ­¥ã€æ‘†æ‰‹è‡‚ä½¿ç”¨">
                </div>
              </div>
            </div>
            
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('template-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="saveTemplate('${taskType}')">ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    function togglePromptConfig() {
      const area = document.getElementById('prompt-config-area');
      const icon = document.getElementById('prompt-toggle-icon');
      if (area.style.display === 'none') {
        area.style.display = 'block';
        icon.textContent = 'â–¼';
      } else {
        area.style.display = 'none';
        icon.textContent = 'â–¶';
      }
    }
    
    async function saveTemplate(taskType) {
      const promptConfig = {
        task_intro: document.getElementById('prompt-intro').value.trim(),
        too_fast: document.getElementById('prompt-too-fast').value.trim(),
        paused: document.getElementById('prompt-paused').value.trim(),
        in_progress: document.getElementById('prompt-in-progress').value.trim(),
        completed: document.getElementById('prompt-completed').value.trim(),
        progress: document.getElementById('prompt-progress').value.trim()
      };
      
      const data = {
        task_name: document.getElementById('template-name').value.trim(),
        duration: parseInt(document.getElementById('template-duration').value) || 0,
        count: parseInt(document.getElementById('template-count').value) || 0,
        points: parseInt(document.getElementById('template-points').value) || 0,
        max_speed: parseInt(document.getElementById('template-max-speed').value) || 0,
        min_interval: parseInt(document.getElementById('template-min-interval').value) || 0,
        pause_threshold: parseInt(document.getElementById('template-pause-threshold').value) || 0,
        prompt_config: promptConfig
      };
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/task_templates?task_type=eq.${taskType}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          alert('ä¿å­˜æˆåŠŸï¼');
          document.getElementById('template-modal').remove();
          renderAdminTemplates();
        } else {
          alert('ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }
    
    // ç¼–è¾‘æç¤ºè¯­å¼¹çª—
    function showEditPromptModal(key) {
      const prompt = cachedGlobalPrompts.find(p => p.key === key);
      if (!prompt) return;
      
      const html = `
        <div class="modal show" id="prompt-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
            <div class="modal-title">ç¼–è¾‘æç¤ºè¯­ - ${key}</div>
            <div style="margin-bottom: 12px;">
              <textarea id="prompt-value" style="width: 100%; height: 100px; padding: 8px;">${prompt.value || ''}</textarea>
            </div>
            <div class="modal-buttons">
              <button class="modal-btn cancel" onclick="document.getElementById('prompt-modal').remove()">å–æ¶ˆ</button>
              <button class="modal-btn confirm" onclick="savePrompt('${key}')">ä¿å­˜</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', html);
    }
    
    async function savePrompt(key) {
      const value = document.getElementById('prompt-value').value.trim();
      
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/global_prompts?key=eq.${key}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ value: value })
        });
        
        if (res.ok) {
          alert('ä¿å­˜æˆåŠŸï¼');
          document.getElementById('prompt-modal').remove();
          renderAdminPrompts();
        } else {
          alert('ä¿å­˜å¤±è´¥');
        }
      } catch (e) {
        alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      document.getElementById('config-name').textContent = CLOUD_CONFIG.name;
      document.getElementById('realtime-content').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      await loadData();
      renderRealtime();
    }

    init();
    setInterval(refreshData, 30000);
  </script>
</body>
</html>
